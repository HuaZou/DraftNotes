<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 12 Functional Analysis | 生物信息随记</title>
<meta name="author" content="Hua Zou">
<meta name="description" content="代谢物通路包含了基因、催化酶或代谢物等上下游关系的先验知识，通过将关心的代谢物比对到通路上，再根据如超级几何分析等数学方法计算受影响的代谢物是否能够影响通路。...">
<meta name="generator" content="bookdown 0.37 with bs4_book()">
<meta property="og:title" content="Chapter 12 Functional Analysis | 生物信息随记">
<meta property="og:type" content="book">
<meta property="og:url" content="https://zouhua.top/DraftNotes/FunctionalAnalysis.html">
<meta property="og:description" content="代谢物通路包含了基因、催化酶或代谢物等上下游关系的先验知识，通过将关心的代谢物比对到通路上，再根据如超级几何分析等数学方法计算受影响的代谢物是否能够影响通路。...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 12 Functional Analysis | 生物信息随记">
<meta name="twitter:description" content="代谢物通路包含了基因、催化酶或代谢物等上下游关系的先验知识，通过将关心的代谢物比对到通路上，再根据如超级几何分析等数学方法计算受影响的代谢物是否能够影响通路。...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/Poppins-0.4.8/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.6.1/transition.js"></script><script src="libs/bs3compat-0.6.1/tabs.js"></script><script src="libs/bs3compat-0.6.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.31/datatables.js"></script><link href="libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.1/js/crosstalk.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="assets/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">生物信息随记</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> 介绍</a></li>
<li class="book-part">Data Set</li>
<li><a class="" href="ZeybelDataset.html"><span class="header-section-number">2</span> Zeybel Dataset</a></li>
<li class="book-part">Statistical Methods</li>
<li><a class="" href="GEEandMLM.html"><span class="header-section-number">3</span> GEE and MLM</a></li>
<li><a class="" href="HypothesisTestingMethods.html"><span class="header-section-number">4</span> Hypothesis Testing Methods</a></li>
<li><a class="" href="BatchEffectCorrection.html"><span class="header-section-number">5</span> Batch Effect Correction</a></li>
<li><a class="" href="LinearModelonMicrobialCommunity.html"><span class="header-section-number">6</span> Linear Model on Microbial Community</a></li>
<li><a class="" href="PermutationTest.html"><span class="header-section-number">7</span> Permutation Test</a></li>
<li><a class="" href="SurvivalAnalysis.html"><span class="header-section-number">8</span> Survival Analysis</a></li>
<li class="book-part">Metabolomics Data Analysis</li>
<li><a class="" href="dataprocessing.html"><span class="header-section-number">9</span> Data Processing</a></li>
<li><a class="" href="DimensionReduction.html"><span class="header-section-number">10</span> Dimension Reduction</a></li>
<li><a class="" href="DifferetialAnalysis.html"><span class="header-section-number">11</span> Differetial Analysis</a></li>
<li><a class="active" href="FunctionalAnalysis.html"><span class="header-section-number">12</span> Functional Analysis</a></li>
<li><a class="" href="MetOriginAnalysis.html"><span class="header-section-number">13</span> MetOrigin Analysis</a></li>
<li><a class="" href="OtherAnalysis.html"><span class="header-section-number">14</span> Other Analysis</a></li>
<li class="book-part">Metagenomics Data Analysis</li>
<li><a class="" href="MultipleDifferetialAnalysis.html"><span class="header-section-number">15</span> Multiple Differetial Analysis</a></li>
<li class="book-part">Machine Learning</li>
<li><a class="" href="randomforestalgorithm.html"><span class="header-section-number">16</span> Random Forest Algorithm</a></li>
<li><a class="" href="XGBoostalgorithm.html"><span class="header-section-number">17</span> XGBoost Algorithm</a></li>
<li class="book-part">Knowledge</li>
<li><a class="" href="Metageomics.html"><span class="header-section-number">18</span> Metageomics</a></li>
<li><a class="" href="Notes.html"><span class="header-section-number">19</span> Notes</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/HuaZou/DraftNotes">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="FunctionalAnalysis" class="section level1" number="12">
<h1>
<span class="header-section-number">12</span> Functional Analysis<a class="anchor" aria-label="anchor" href="#FunctionalAnalysis"><i class="fas fa-link"></i></a>
</h1>
<p>代谢物通路包含了基因、催化酶或代谢物等上下游关系的先验知识，通过将关心的代谢物比对到通路上，再根据如超级几何分析等数学方法计算受影响的代谢物是否能够影响通路。</p>
<p>代谢物富集分析的目的是为了解析某些差异代谢物是否落在某些pathway上（<em>可简单理解为单个差异代谢物解释pathway较弱，同一pathway的代谢物共同解释该通路变化则证据较为robust，在很多生物领域均存在类似的处理逻辑</em>），进而影响pathway的功能。基于pathway可分析代谢物的上下游基因或酶等影响，最终阐明作用机制。</p>
<p>代谢组服务公司反馈回来的代谢组表一般是基于intensity也即是质谱峰强度的数据，需要做前处理方可使用。本次使用直接处理后的数据用于分析。</p>
<p>功能分析方法主流有三类：</p>
<ul>
<li><p><strong>ORA (Over-Representative analysis)</strong>：将表达基因ORA放置在通路内，通过超级几何检验判断这些基因是否随机出现在通路内，从而判断功能是否富集</p></li>
<li><p><strong>GSEA (Gene set enrichment analysis)</strong>：将所有基因按照log2foldchange的可以排序基因顺序的指标排序，再计算它们出现在每个通路的累积富集分数</p></li>
<li><p><strong>ssGSEA (single sample Gene set enrichment analysis)</strong>：将每个样本的基因或代谢物表达值作为输入文件，结合对应通路数据库list，再计算每个通路的每个样本的累积富集分数</p></li>
</ul>
<p><strong>注意：代谢组ID也有类似基因ID的多平台多命名问题，可以参考类似的名称转换工具包。本次直接使用cpdid，可直接用于KEGG COMPOUND数据库。</strong></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="22%">
<col width="22%">
<col width="11%">
<col width="22%">
<col width="22%">
</colgroup>
<thead><tr class="header">
<th>Analysis</th>
<th>输入文件</th>
<th>输出结果</th>
<th>✅ 优点</th>
<th>⚠️ 缺点</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>ORA (Over-representation Analysis)</strong></td>
<td>基因或代谢物等列表 (一般输入差异表达基因列表)</td>
<td>每条通路的超几何检验结果</td>
<td>简单；计算检验结果消耗计算资源少</td>
<td>需要任意随心的基因阈值（比如选择上调基因），忽略与基因相关的任何统计数据；假设基因和通路的独立性</td>
</tr>
<tr class="even">
<td><strong>GSEA (Gene Set Enrichment Analysis)</strong></td>
<td>具有基因水平统计结果（如差异检验的log2foldchange）的基因id列表</td>
<td>每条通路的富集打分</td>
<td>包含所有基因(不是任意选择的阈值) ；试图计算基因之间的协调性</td>
<td>permutation计算资源消耗大；不能解释重叠通路的关系；两组比较不总是合适或可行的</td>
</tr>
<tr class="odd">
<td>
<strong>GSVA (Gene Set Variation Analysis)</strong>或<strong>ssGSEA (Single sample gene set enrichment analysis)</strong>
</td>
<td>基因表达谱（一般行是基因，列是样本）</td>
<td>基于每个样本的通路水平的富集分数</td>
<td>不需要两组事先比较；输入数据要求正态分布（一般会对表达矩阵做转换处理）</td>
<td>不适合包含上下调基因的基因集合；该方法本身不具有统计显著性；建议样本量大于10才采用该方法</td>
</tr>
</tbody>
</table></div>
<div id="加载r包-8" class="section level2" number="12.1">
<h2>
<span class="header-section-number">12.1</span> 加载R包<a class="anchor" aria-label="anchor" href="#%E5%8A%A0%E8%BD%BDr%E5%8C%85-8"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>message <span class="op">=</span> <span class="cn">FALSE</span>, warning <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymass/massdatabase">massdatabase</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yulab-smu.top/biomedical-knowledge-mining-book/">clusterProfiler</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/YuLab-SMU/MicrobiomeProfiler/">MicrobiomeProfiler</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># rm(list = ls())</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>stringsAsFactors <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>future.globals.maxSize <span class="op">=</span> <span class="fl">1000</span> <span class="op">*</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">grp_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span>, <span class="st">"Moderate"</span>, <span class="st">"Severe"</span><span class="op">)</span></span>
<span><span class="va">grp_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#7DD06F"</span>, <span class="st">"#844081"</span>, <span class="st">"#688EC1"</span>, <span class="st">"#C17E73"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="导入数据-6" class="section level2" number="12.2">
<h2>
<span class="header-section-number">12.2</span> 导入数据<a class="anchor" aria-label="anchor" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE-6"><i class="fas fa-link"></i></a>
</h2>
<p>对数据<a href="https://github.com/HuaZou/DraftNotes/blob/main/InputData/Zeybel-2022/OmicsDataSet-Zeybel%20et%20al.%20-%202022.xlsx">OmicsDataSet-Zeybel et al. - 2022.xlsx</a>处理后生成的，可参考数据预处理等章节。</p>
<blockquote>
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span><span class="op">(</span><span class="va">final_res</span>, <span class="st">"./InputData/result/DA/Metabolites_FC_VIP_ttest.tsv"</span>, </span>
<span>row.names <span class="op">=</span> <span class="cn">F</span>, quote <span class="op">=</span> <span class="cn">F</span>, sep <span class="op">=</span> <span class="st">"\t"</span>, fileEncoding <span class="op">=</span> <span class="st">"UTF-8"</span><span class="op">)</span></span></code></pre></div>
</blockquote>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datSignif</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="st">"./InputData/result/DA/Metabolites_FC_VIP_ttest.tsv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># DT::datatable(datSignif)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">datSignif</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                         FeatureID</span></span>
<span><span class="co">#&gt;                                            &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: ceramide (d18:1/20:0, d16:1/22:0, d20:1/18:0)*</span></span>
<span><span class="co">#&gt; 2:                 cysteine-glutathione disulfide</span></span>
<span><span class="co">#&gt; 3:                                         serine</span></span>
<span><span class="co">#&gt; 4:          1-palmitoyl-2-oleoyl-GPI (16:0/18:1)*</span></span>
<span><span class="co">#&gt; 5:           1-stearoyl-2-oleoyl-GPI (18:0/18:1)*</span></span>
<span><span class="co">#&gt; 6:     palmitoyl-oleoyl-glycerol (16:0/18:1) [2]*</span></span>
<span><span class="co">#&gt;            Block2                Block FoldChange</span></span>
<span><span class="co">#&gt;            &lt;char&gt;               &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: None vs Severe 10_None vs 12_Severe  0.6444244</span></span>
<span><span class="co">#&gt; 2: None vs Severe 10_None vs 12_Severe  1.7109000</span></span>
<span><span class="co">#&gt; 3: None vs Severe 10_None vs 12_Severe  1.2218596</span></span>
<span><span class="co">#&gt; 4: None vs Severe 10_None vs 12_Severe  0.5199556</span></span>
<span><span class="co">#&gt; 5: None vs Severe 10_None vs 12_Severe  0.5667863</span></span>
<span><span class="co">#&gt; 6: None vs Severe 10_None vs 12_Severe  0.5638085</span></span>
<span><span class="co">#&gt;    Log2FoldChange      VIP    CorPvalue Statistic</span></span>
<span><span class="co">#&gt;             &lt;num&gt;    &lt;num&gt;        &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     -0.6339170 2.713879 6.487126e-05 -4.923988</span></span>
<span><span class="co">#&gt; 2:      0.7747554 2.653166 1.139027e-04  4.989637</span></span>
<span><span class="co">#&gt; 3:      0.2890785 2.531054 3.153670e-04  4.409792</span></span>
<span><span class="co">#&gt; 4:     -0.9435396 2.539496 2.952154e-04 -4.294439</span></span>
<span><span class="co">#&gt; 5:     -0.8191231 2.488347 4.365061e-04 -4.098726</span></span>
<span><span class="co">#&gt; 6:     -0.8267228 2.398322 8.276438e-04 -3.781813</span></span>
<span><span class="co">#&gt;          Pvalue AdjustedPvalue Mean Abundance (All)</span></span>
<span><span class="co">#&gt;           &lt;num&gt;          &lt;num&gt;                &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 1.234968e-04     0.03958071              3841099</span></span>
<span><span class="co">#&gt; 2: 8.636192e-05     0.03958071              1246453</span></span>
<span><span class="co">#&gt; 3: 2.705095e-04     0.05779885             63358904</span></span>
<span><span class="co">#&gt; 4: 4.600563e-04     0.07372402              2243154</span></span>
<span><span class="co">#&gt; 5: 7.802676e-04     0.10003031              1817773</span></span>
<span><span class="co">#&gt; 6: 1.814397e-03     0.16614697              1192929</span></span>
<span><span class="co">#&gt;    Mean Abundance None Mean Abundance Severe  metabolitesID</span></span>
<span><span class="co">#&gt;                  &lt;num&gt;                 &lt;num&gt;         &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:           2952496.1             4581602.1 Chem_100015755</span></span>
<span><span class="co">#&gt; 2:           1611743.8              942044.4 Chem_100001437</span></span>
<span><span class="co">#&gt; 3:          70323857.2            57554776.3       Chem_503</span></span>
<span><span class="co">#&gt; 4:           1491869.7             2869225.1 Chem_100009066</span></span>
<span><span class="co">#&gt; 5:           1282914.5             2263488.8 Chem_100009181</span></span>
<span><span class="co">#&gt; 6:            838913.8             1487941.0 Chem_100010917</span></span>
<span><span class="co">#&gt;                                       BIOCHEMICAL</span></span>
<span><span class="co">#&gt;                                            &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: ceramide (d18:1/20:0, d16:1/22:0, d20:1/18:0)*</span></span>
<span><span class="co">#&gt; 2:                 cysteine-glutathione disulfide</span></span>
<span><span class="co">#&gt; 3:                                         serine</span></span>
<span><span class="co">#&gt; 4:          1-palmitoyl-2-oleoyl-GPI (16:0/18:1)*</span></span>
<span><span class="co">#&gt; 5:           1-stearoyl-2-oleoyl-GPI (18:0/18:1)*</span></span>
<span><span class="co">#&gt; 6:     palmitoyl-oleoyl-glycerol (16:0/18:1) [2]*</span></span>
<span><span class="co">#&gt;    SUPER.PATHWAY                              SUB.PATHWAY</span></span>
<span><span class="co">#&gt;           &lt;char&gt;                                   &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:         Lipid                                Ceramides</span></span>
<span><span class="co">#&gt; 2:    Amino Acid                   Glutathione Metabolism</span></span>
<span><span class="co">#&gt; 3:    Amino Acid Glycine, Serine and Threonine Metabolism</span></span>
<span><span class="co">#&gt; 4:         Lipid                Phosphatidylinositol (PI)</span></span>
<span><span class="co">#&gt; 5:         Lipid                Phosphatidylinositol (PI)</span></span>
<span><span class="co">#&gt; 6:         Lipid                           Diacylglycerol</span></span>
<span><span class="co">#&gt;    COMPID        PLATFORM CHEMICALID    RI     MASS</span></span>
<span><span class="co">#&gt;     &lt;int&gt;          &lt;char&gt;      &lt;int&gt; &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  57440  LC/MS Pos Late  100015755  3920 594.5820</span></span>
<span><span class="co">#&gt; 2:  35159 LC/MS Pos Early  100001437  2465 427.0952</span></span>
<span><span class="co">#&gt; 3:   1648 LC/MS Pos Early        503  1239 106.0499</span></span>
<span><span class="co">#&gt; 4:  52669  LC/MS Pos Late  100009066  3140 854.5753</span></span>
<span><span class="co">#&gt; 5:  52726  LC/MS Pos Late  100009181  3711 882.6066</span></span>
<span><span class="co">#&gt; 6:  54942  LC/MS Pos Late  100010917  3695 612.5562</span></span>
<span><span class="co">#&gt;     PUBCHEM        CAS   KEGG SampleIDHMDBID</span></span>
<span><span class="co">#&gt;      &lt;char&gt;     &lt;char&gt; &lt;char&gt;         &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:     &lt;NA&gt;       &lt;NA&gt;   &lt;NA&gt;           &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2:  3080690 13081-14-6 R00900    HMDB0000656</span></span>
<span><span class="co">#&gt; 3:     5951    56-45-1 C00065    HMDB0000187</span></span>
<span><span class="co">#&gt; 4: 71296232       &lt;NA&gt;   &lt;NA&gt;    HMDB0009783</span></span>
<span><span class="co">#&gt; 5:     &lt;NA&gt;       &lt;NA&gt;   &lt;NA&gt;           &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6:  5282283       &lt;NA&gt; C13861    HMDB0007102</span></span></code></pre></div>
</div>
<div id="获取kegg-pathway和代谢物id对应关系" class="section level2" number="12.3">
<h2>
<span class="header-section-number">12.3</span> 获取KEGG pathway和代谢物ID对应关系<a class="anchor" aria-label="anchor" href="#%E8%8E%B7%E5%8F%96kegg-pathway%E5%92%8C%E4%BB%A3%E8%B0%A2%E7%89%A9id%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><i class="fas fa-link"></i></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>下载KEGG pathway对应的compound信息。本次分析是针对人，因此在选择pathway的时候物种设置为人</p></li>
<li><p>读取每个pathway包含的compound后，整理成pathway和compound一一对应的关系表</p></li>
</ol>
<p>合并1和2步骤为一个脚本，步骤1推荐使用<code>massdatabase</code>R包，该步是为了获取特定物种的pathway和compound对应关系</p>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_kegg_pathway_compound</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">org_id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hsa"</span>, <span class="st">"mmu"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">pathway_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/massdatabase/man/request_kegg_pathway_info.html">request_kegg_pathway_info</a></span><span class="op">(</span>organism <span class="op">=</span> <span class="va">org_id</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pathway_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">temp_pathway</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/massdatabase/man/request_kegg_pathway.html">request_kegg_pathway</a></span><span class="op">(</span>pathway_id <span class="op">=</span> <span class="va">pathway_names</span><span class="op">$</span><span class="va">KEGG.ID</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">temp_colnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">temp_pathway</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"COMPOUND"</span>, <span class="st">"ENTRY"</span>, <span class="st">"NAME"</span>, <span class="st">"CLASS"</span>, <span class="st">"PATHWAY_MAP"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">temp_colnames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>      <span class="va">temp_compound</span> <span class="op">&lt;-</span> <span class="va">temp_pathway</span><span class="op">$</span><span class="va">COMPOUND</span></span>
<span>      <span class="va">temp_class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">temp_pathway</span><span class="op">$</span><span class="va">CLASS</span>, <span class="st">"; "</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">temp_df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Pathway <span class="op">=</span> <span class="va">temp_pathway</span><span class="op">$</span><span class="va">ENTRY</span>,</span>
<span>                             NAME <span class="op">=</span> <span class="va">temp_pathway</span><span class="op">$</span><span class="va">NAME</span>,</span>
<span>                             <span class="co">#DESCRIPTION = temp_pathway$DESCRIPTION,</span></span>
<span>                             CLASS1 <span class="op">=</span> <span class="va">temp_class</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                             CLASS2 <span class="op">=</span> <span class="va">temp_class</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                             PATHWAY_MAP <span class="op">=</span> <span class="va">temp_pathway</span><span class="op">$</span><span class="va">PATHWAY_MAP</span><span class="op">)</span></span>
<span>      <span class="va">temp_df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Pathway <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">temp_pathway</span><span class="op">$</span><span class="va">ENTRY</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">temp_compound</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                             COMPOUND <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">temp_compound</span><span class="op">)</span>,</span>
<span>                             COMPOUND_DESCRIPTION <span class="op">=</span> <span class="va">temp_compound</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">temp_df</span> <span class="op">&lt;-</span> <span class="va">temp_df1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">temp_df2</span>, by <span class="op">=</span> <span class="st">"Pathway"</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">temp_df</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="st">"./InputData/result/KEGG/"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="st">"./InputData/result/KEGG/"</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="st">"./InputData/result/KEGG/KEGG_COMPOUND_PATHWAY_hsa.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">hsa_kegg_compound</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"./InputData/result/KEGG/KEGG_COMPOUND_PATHWAY_hsa.csv"</span><span class="op">)</span> </span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">hsa_kegg_compound</span> <span class="op">&lt;-</span> <span class="fu">get_kegg_pathway_compound</span><span class="op">(</span>org_id <span class="op">=</span> <span class="st">"hsa"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">hsa_kegg_compound</span>, <span class="st">"./InputData/result/KEGG/KEGG_COMPOUND_PATHWAY_hsa.csv"</span>, row.names <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># DT::datatable(hsa_kegg_compound)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">hsa_kegg_compound</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Pathway</span></span>
<span><span class="co">#&gt; 1 hsa00010</span></span>
<span><span class="co">#&gt; 2 hsa00010</span></span>
<span><span class="co">#&gt; 3 hsa00010</span></span>
<span><span class="co">#&gt; 4 hsa00010</span></span>
<span><span class="co">#&gt; 5 hsa00010</span></span>
<span><span class="co">#&gt; 6 hsa00010</span></span>
<span><span class="co">#&gt;                                                  NAME</span></span>
<span><span class="co">#&gt; 1 Glycolysis / Gluconeogenesis - Homo sapiens (human)</span></span>
<span><span class="co">#&gt; 2 Glycolysis / Gluconeogenesis - Homo sapiens (human)</span></span>
<span><span class="co">#&gt; 3 Glycolysis / Gluconeogenesis - Homo sapiens (human)</span></span>
<span><span class="co">#&gt; 4 Glycolysis / Gluconeogenesis - Homo sapiens (human)</span></span>
<span><span class="co">#&gt; 5 Glycolysis / Gluconeogenesis - Homo sapiens (human)</span></span>
<span><span class="co">#&gt; 6 Glycolysis / Gluconeogenesis - Homo sapiens (human)</span></span>
<span><span class="co">#&gt;       CLASS1                  CLASS2</span></span>
<span><span class="co">#&gt; 1 Metabolism Carbohydrate metabolism</span></span>
<span><span class="co">#&gt; 2 Metabolism Carbohydrate metabolism</span></span>
<span><span class="co">#&gt; 3 Metabolism Carbohydrate metabolism</span></span>
<span><span class="co">#&gt; 4 Metabolism Carbohydrate metabolism</span></span>
<span><span class="co">#&gt; 5 Metabolism Carbohydrate metabolism</span></span>
<span><span class="co">#&gt; 6 Metabolism Carbohydrate metabolism</span></span>
<span><span class="co">#&gt;                    PATHWAY_MAP COMPOUND</span></span>
<span><span class="co">#&gt; 1 Glycolysis / Gluconeogenesis   C00022</span></span>
<span><span class="co">#&gt; 2 Glycolysis / Gluconeogenesis   C00024</span></span>
<span><span class="co">#&gt; 3 Glycolysis / Gluconeogenesis   C00031</span></span>
<span><span class="co">#&gt; 4 Glycolysis / Gluconeogenesis   C00033</span></span>
<span><span class="co">#&gt; 5 Glycolysis / Gluconeogenesis   C00036</span></span>
<span><span class="co">#&gt; 6 Glycolysis / Gluconeogenesis   C00068</span></span>
<span><span class="co">#&gt;   COMPOUND_DESCRIPTION</span></span>
<span><span class="co">#&gt; 1             Pyruvate</span></span>
<span><span class="co">#&gt; 2           Acetyl-CoA</span></span>
<span><span class="co">#&gt; 3            D-Glucose</span></span>
<span><span class="co">#&gt; 4              Acetate</span></span>
<span><span class="co">#&gt; 5         Oxaloacetate</span></span>
<span><span class="co">#&gt; 6  Thiamin diphosphate</span></span></code></pre></div>
</div>
<div id="差异代谢物筛选" class="section level2" number="12.4">
<h2>
<span class="header-section-number">12.4</span> 差异代谢物筛选<a class="anchor" aria-label="anchor" href="#%E5%B7%AE%E5%BC%82%E4%BB%A3%E8%B0%A2%E7%89%A9%E7%AD%9B%E9%80%89"><i class="fas fa-link"></i></a>
</h2>
<p>根据ORA或GSEA的原理，可以选择上下调差异代谢物或者按照log2foldchange排序好的代谢物用于差异分析</p>
<ul>
<li><p>none: 所有代谢物</p></li>
<li><p>all: 所有差异代谢物</p></li>
<li><p>up (UpRegulated): 上调差异代谢物</p></li>
<li><p>down (DownRegulated): 下调差异代谢物</p></li>
</ul>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_significant</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">dat</span>,</span>
<span>    <span class="va">group_names</span>,</span>
<span>    <span class="va">lg2fc_cutoff</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    <span class="va">pval_cutoff</span> <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    <span class="va">qval_cutoff</span> <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">dat_group</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Block2</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">group_names</span>, collapse <span class="op">=</span> <span class="st">" vs "</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># remove KEGG eq "-" or NA</span></span>
<span>  <span class="va">dat_fa</span> <span class="op">&lt;-</span> <span class="va">dat_group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">KEGG</span> <span class="op">!=</span> <span class="st">"-"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">KEGG</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cpd_ID <span class="op">=</span> <span class="va">KEGG</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Log2FoldChange"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"lg2fc"</span> <span class="co"># Log2FoldChange (Median)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Pvalue"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"pval"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">)</span> <span class="op">==</span> <span class="st">"AdjustedPvalue"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"qval"</span></span>
<span>  </span>
<span>  <span class="co"># convert NA into 1</span></span>
<span>  <span class="va">dat_fa</span><span class="op">$</span><span class="va">qval</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">$</span><span class="va">qval</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co"># enrichment by beta and Pvalue AdjustedPvalue</span></span>
<span>  <span class="va">dat_fa</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">$</span><span class="va">lg2fc</span> <span class="op">&gt;</span> <span class="va">lg2fc_cutoff</span> <span class="op">&amp;</span></span>
<span>              <span class="va">dat_fa</span><span class="op">$</span><span class="va">pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span> <span class="op">&amp;</span></span>
<span>              <span class="va">dat_fa</span><span class="op">$</span><span class="va">qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">dat_fa</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">$</span><span class="va">lg2fc</span> <span class="op">&lt;</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span> <span class="op">&amp;</span></span>
<span>              <span class="va">dat_fa</span><span class="op">$</span><span class="va">pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span> <span class="op">&amp;</span></span>
<span>              <span class="va">dat_fa</span><span class="op">$</span><span class="va">qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">dat_fa</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">$</span><span class="va">lg2fc</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">lg2fc_cutoff</span> <span class="op">|</span></span>
<span>              <span class="va">dat_fa</span><span class="op">$</span><span class="va">pval</span> <span class="op">&gt;=</span> <span class="va">pval_cutoff</span> <span class="op">|</span></span>
<span>              <span class="va">dat_fa</span><span class="op">$</span><span class="va">qval</span> <span class="op">&gt;=</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Nonsignif"</span></span>
<span></span>
<span>  <span class="co"># dat status</span></span>
<span>  <span class="va">dat_fa</span><span class="op">$</span><span class="va">EnrichedDir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">$</span><span class="va">EnrichedDir</span>,</span>
<span>                            levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"Nonsignif"</span>, <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">df_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">dat_fa</span><span class="op">$</span><span class="va">EnrichedDir</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Group"</span>, <span class="st">"Number"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">grp1_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">grp2_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">nsf_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"Nonsignif"</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">legend_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" ("</span>, <span class="va">grp1_number</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Nonsignif"</span>, <span class="st">" ("</span>, <span class="va">nsf_number</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">" ("</span>, <span class="va">grp2_number</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># significant features</span></span>
<span>  <span class="va">dat_signif</span> <span class="op">&lt;-</span> <span class="va">dat_fa</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">lg2fc</span>, <span class="va">pval</span>, <span class="va">qval</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">lg2fc</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">lg2fc_cutoff</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FeatureID</span>, <span class="va">Block</span>, <span class="va">EnrichedDir</span>, <span class="va">lg2fc</span>, <span class="va">pval</span>, <span class="va">qval</span>, <span class="va">cpd_ID</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>FeatureID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\."</span>, <span class="st">"-"</span>, <span class="va">FeatureID</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># print(table(dat_signif$EnrichedDir))</span></span>
<span></span>
<span>  <span class="va">res_up</span> <span class="op">&lt;-</span> <span class="va">dat_signif</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># enriched in 1st group</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">EnrichedDir</span> <span class="op">==</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Status <span class="op">=</span> <span class="st">"UpRegulated"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">res_down</span> <span class="op">&lt;-</span> <span class="va">dat_signif</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># enriched in 2st group</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">EnrichedDir</span> <span class="op">==</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Status <span class="op">=</span> <span class="st">"DownRegulated"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>none <span class="op">=</span> <span class="va">dat_fa</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FeatureID</span>, <span class="va">Block</span>, <span class="va">EnrichedDir</span>, <span class="va">lg2fc</span>, <span class="va">pval</span>, <span class="va">qval</span>, <span class="va">cpd_ID</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              all <span class="op">=</span> <span class="va">dat_signif</span>,</span>
<span>              up <span class="op">=</span> <span class="va">res_up</span>,</span>
<span>              down <span class="op">=</span> <span class="va">res_down</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div id="富集分析" class="section level2" number="12.5">
<h2>
<span class="header-section-number">12.5</span> 富集分析<a class="anchor" aria-label="anchor" href="#%E5%AF%8C%E9%9B%86%E5%88%86%E6%9E%90"><i class="fas fa-link"></i></a>
</h2>
<p>用ClusterProfiler提供的enrichr和GESA做分析，这两个函数可自行配置输入pathway database，然后采用超几何检验和富集rank得分评估富集状况。除了常见的KEGG 通路富集分析外，还可以有Gene Ontology和MSigDB Hallmark gene sets等富集分析数据库。</p>
<blockquote>
<p>Gene Ontology: Biological Process (BP), Cellular Component (CC) 和 Molecular Function (MF)</p>
</blockquote>
<ul>
<li><p>ORA: 差异代谢物的超级几何检验</p></li>
<li><p>GSEA: 排好序的代谢物的富集rank打分</p></li>
</ul>
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_enrichment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">dat</span>,</span>
<span>  <span class="va">ref</span>,</span>
<span>  <span class="va">group_names</span>,</span>
<span>  <span class="va">direction</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"none"</span>, <span class="st">"All"</span>, <span class="st">"DownRegulated"</span>, <span class="st">"UpRegulated"</span><span class="op">)</span>, <span class="co"># DownRegulated-&gt;1st group; UpRegulated-&gt;2nd group </span></span>
<span>  <span class="va">lg2fc_cutoff</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  <span class="va">pval_cutoff</span> <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  <span class="va">qval_cutoff</span> <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  <span class="va">enrich_type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ORA"</span>, <span class="st">"GSEA"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">temp_input</span> <span class="op">&lt;-</span> <span class="fu">get_significant</span><span class="op">(</span></span>
<span>    dat <span class="op">=</span> <span class="va">dat</span>,</span>
<span>    group_names <span class="op">=</span> <span class="va">group_names</span>,</span>
<span>    lg2fc_cutoff <span class="op">=</span> <span class="va">lg2fc_cutoff</span>,</span>
<span>    pval_cutoff <span class="op">=</span> <span class="va">pval_cutoff</span>,</span>
<span>    qval_cutoff <span class="op">=</span> <span class="va">qval_cutoff</span><span class="op">)</span>  </span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">direction</span> <span class="op">==</span> <span class="st">"All"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inputdata</span> <span class="op">&lt;-</span> <span class="va">temp_input</span><span class="op">$</span><span class="va">all</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">direction</span> <span class="op">==</span> <span class="st">"UpRegulated"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inputdata</span> <span class="op">&lt;-</span> <span class="va">temp_input</span><span class="op">$</span><span class="va">up</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">direction</span> <span class="op">==</span> <span class="st">"DownRegulated"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inputdata</span> <span class="op">&lt;-</span> <span class="va">temp_input</span><span class="op">$</span><span class="va">down</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">direction</span> <span class="op">==</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inputdata</span> <span class="op">&lt;-</span> <span class="va">temp_input</span><span class="op">$</span><span class="va">none</span></span>
<span>  <span class="op">}</span> </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">inputdata</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Beyond these thresholds, no significant metabolites were selected"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>  </span>
<span>  </span>
<span>  <span class="va">inputdata</span><span class="op">$</span><span class="va">cpd_ID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\s+\\|\\s+\\w+\\d+"</span>, <span class="st">""</span>, <span class="va">inputdata</span><span class="op">$</span><span class="va">cpd_ID</span><span class="op">)</span></span>
<span>  <span class="va">inputdata</span><span class="op">$</span><span class="va">cpd_ID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">",\\S+"</span>, <span class="st">""</span>, <span class="va">inputdata</span><span class="op">$</span><span class="va">cpd_ID</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">ref_cln</span> <span class="op">&lt;-</span> <span class="va">ref</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">PATHWAY_MAP</span>, <span class="va">COMPOUND</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>Pathway <span class="op">=</span> <span class="va">PATHWAY_MAP</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">enrich_type</span> <span class="op">==</span> <span class="st">"ORA"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">clusterProfiler</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/clusterProfiler/man/enricher.html">enricher</a></span><span class="op">(</span></span>
<span>                gene <span class="op">=</span> <span class="va">inputdata</span><span class="op">$</span><span class="va">cpd_ID</span>,</span>
<span>                pvalueCutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                pAdjustMethod <span class="op">=</span> <span class="st">"BH"</span>,</span>
<span>                minGSSize <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                maxGSSize <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                qvalueCutoff <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>                TERM2GENE <span class="op">=</span> <span class="va">ref_cln</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">enrich_type</span> <span class="op">==</span> <span class="st">"GSEA"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dat_GSEA</span> <span class="op">&lt;-</span> <span class="va">inputdata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">lg2fc</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">cpd_lg2fc</span> <span class="op">&lt;-</span> <span class="va">dat_GSEA</span><span class="op">$</span><span class="va">lg2fc</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cpd_lg2fc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">dat_GSEA</span><span class="op">$</span><span class="va">cpd_ID</span></span>
<span>    <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">clusterProfiler</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/clusterProfiler/man/GSEA.html">GSEA</a></span><span class="op">(</span></span>
<span>                geneList <span class="op">=</span> <span class="va">cpd_lg2fc</span>,</span>
<span>                pvalueCutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                pAdjustMethod <span class="op">=</span> <span class="st">"BH"</span>,</span>
<span>                minGSSize <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                maxGSSize <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                TERM2GENE <span class="op">=</span> <span class="va">ref_cln</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">@</span><span class="va">result</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">enrich_type</span> <span class="op">==</span> <span class="st">"ORA"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">EA_res</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">@</span><span class="va">result</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Description</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>CompoundRatio <span class="op">=</span> <span class="va">GeneRatio</span>,</span>
<span>                      CompoundID <span class="op">=</span> <span class="va">geneID</span>,</span>
<span>                      NAME <span class="op">=</span> <span class="va">Description</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">NAME</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>      </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">enrich_type</span> <span class="op">==</span> <span class="st">"GSEA"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">EA_res</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">@</span><span class="va">result</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Description</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>NAME <span class="op">=</span> <span class="va">Description</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">NAME</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>       </span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">EA_res</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">inputdata</span>,</span>
<span>              enrich <span class="op">=</span> <span class="va">EA_res</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div id="可视化通路" class="section level2" number="12.6">
<h2>
<span class="header-section-number">12.6</span> 可视化通路<a class="anchor" aria-label="anchor" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E9%80%9A%E8%B7%AF"><i class="fas fa-link"></i></a>
</h2>
<p>画气泡图或者条形图，根据qvalue和CompoundRatio以及Count画图</p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_enrichment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">inputdata</span>,</span>
<span>    <span class="va">qval_cutoff</span> <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    <span class="va">topN</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    <span class="va">plot_type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bubble"</span>, <span class="st">"bar"</span><span class="op">)</span>,</span>
<span>    <span class="va">enrich_type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ORA"</span>, <span class="st">"GSEA"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">inputdata</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"No pathway please check your input"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>  </span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">enrich_type</span> <span class="op">==</span> <span class="st">"ORA"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">inputdata</span><span class="op">$</span><span class="va">qvalue</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">inputdata</span><span class="op">$</span><span class="va">qvalue</span> <span class="op">&lt;-</span> <span class="va">inputdata</span><span class="op">$</span><span class="va">p.adjust</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">plotdata_temp</span> <span class="op">&lt;-</span> <span class="va">inputdata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="co"># dplyr::select(ID, NAME, CompoundRatio, qvalue, Count, CLASS1, CLASS2, PATHWAY_MAP) %&gt;%</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">NAME</span>, <span class="va">CompoundRatio</span>, <span class="va">qvalue</span>, <span class="va">Count</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>      </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">qvalue</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">plotdata_temp</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"No pathway met the threshold of qvalue"</span><span class="op">)</span></span>
<span>    <span class="op">}</span>    </span>
<span>      </span>
<span>    <span class="va">plotdata</span> <span class="op">&lt;-</span> <span class="va">plotdata_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">topN</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>qvalue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">qvalue</span><span class="op">)</span>,</span>
<span>                    Count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">Count</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>CompoundRatio1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">CompoundRatio</span>, <span class="st">"/"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                    CompoundRatio2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">CompoundRatio</span>, <span class="st">"/"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                    CompoundRatio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">CompoundRatio1</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">CompoundRatio2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CompoundRatio1"</span>, <span class="st">"CompoundRatio2"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>NAME <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">" - Mus musculus \\(house mouse\\)"</span>, <span class="st">""</span>, <span class="va">NAME</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">CompoundRatio</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>Yvalue <span class="op">=</span> <span class="va">CompoundRatio</span><span class="op">)</span></span>
<span>    <span class="va">y_lab</span> <span class="op">&lt;-</span> <span class="st">"CompoundRatio"</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">enrich_type</span> <span class="op">==</span> <span class="st">"GSEA"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">inputdata</span><span class="op">$</span><span class="va">qvalue</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">inputdata</span><span class="op">$</span><span class="va">qvalues</span> <span class="op">&lt;-</span> <span class="va">inputdata</span><span class="op">$</span><span class="va">p.adjust</span></span>
<span>    <span class="op">}</span>    </span>
<span>    <span class="va">plotdata_temp</span> <span class="op">&lt;-</span> <span class="va">inputdata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="co"># dplyr::select(ID, NAME, enrichmentScore, qvalues, setSize, CLASS1, CLASS2, PATHWAY_MAP) %&gt;%</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">NAME</span>, <span class="va">enrichmentScore</span>, <span class="va">qvalues</span>, <span class="va">setSize</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>      </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">qvalues</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">plotdata_temp</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"No pathway met the threshold of qvalue"</span><span class="op">)</span></span>
<span>    <span class="op">}</span>    </span>
<span>      </span>
<span>    <span class="va">plotdata</span> <span class="op">&lt;-</span> <span class="va">plotdata_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">topN</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>qvalue <span class="op">=</span> <span class="va">qvalues</span>,</span>
<span>                    Count <span class="op">=</span> <span class="va">setSize</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>qvalue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">qvalue</span><span class="op">)</span>,</span>
<span>                    Count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">Count</span><span class="op">)</span>,</span>
<span>                    enrichmentScore <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">enrichmentScore</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>NAME <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">" - Mus musculus \\(house mouse\\)"</span>, <span class="st">""</span>, <span class="va">NAME</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">enrichmentScore</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>Yvalue <span class="op">=</span> <span class="va">enrichmentScore</span><span class="op">)</span></span>
<span>    <span class="va">y_lab</span> <span class="op">&lt;-</span> <span class="st">"enrichmentScore"</span></span>
<span>  <span class="op">}</span> </span>
<span></span>
<span>  <span class="va">plotdata</span><span class="op">$</span><span class="va">NAME</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">plotdata</span><span class="op">$</span><span class="va">NAME</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">plotdata</span><span class="op">$</span><span class="va">NAME</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">final_topN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">plotdata</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">plot_type</span> <span class="op">==</span> <span class="st">"bubble"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plotdata</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">NAME</span>, y <span class="op">=</span> <span class="va">Yvalue</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">Count</span>, color <span class="op">=</span> <span class="va">qvalue</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="va">y_lab</span>, title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Top"</span>, <span class="va">final_topN</span>, <span class="st">"of Enrichment"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>order <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>order <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_color_gradientn</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"q value"</span>, </span>
<span>                            colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">rainbow</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">'bold'</span>, size <span class="op">=</span> <span class="fl">12</span>, hjust <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,</span>
<span>            axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">'bold'</span>, size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>            axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">'bold'</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>            legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">plot_type</span> <span class="op">==</span> <span class="st">"bar"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plotdata</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">NAME</span>, y <span class="op">=</span> <span class="va">Yvalue</span>, fill <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">qvalue</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="va">y_lab</span>, title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Top"</span>, <span class="va">final_topN</span>, <span class="st">"of Enrichment"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>order <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_color_gradientn</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"-log10(q value)"</span>,</span>
<span>                            colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">rainbow</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">'bold'</span>, size <span class="op">=</span> <span class="fl">12</span>, hjust <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,</span>
<span>            axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">'bold'</span>, size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>            axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">'bold'</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>            legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>      </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pl</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div id="案例-1" class="section level2" number="12.7">
<h2>
<span class="header-section-number">12.7</span> 案例<a class="anchor" aria-label="anchor" href="#%E6%A1%88%E4%BE%8B-1"><i class="fas fa-link"></i></a>
</h2>
<p>比较”None”和”Severe”两组的差异代谢物在KEGG通路上是否显著富集。在明确富集通路后，可聚焦在这些通路的代谢物，通过解析上下游代谢物的变化，进而阐明潜在的生物学机制。</p>
<ul>
<li>ORA: 所有差异代谢物富集分析结果</li>
</ul>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ORA_res</span> <span class="op">&lt;-</span> <span class="fu">get_enrichment</span><span class="op">(</span></span>
<span>  dat <span class="op">=</span> <span class="va">datSignif</span>,</span>
<span>  ref <span class="op">=</span> <span class="va">hsa_kegg_compound</span>,</span>
<span>  group <span class="op">=</span> <span class="va">grp_names</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  direction <span class="op">=</span> <span class="st">"All"</span>,  </span>
<span>  lg2fc_cutoff <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  pval_cutoff <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  qval_cutoff <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  enrich_type <span class="op">=</span> <span class="st">"ORA"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ORA_res</span><span class="op">$</span><span class="va">enrich</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                                                                      ID</span></span>
<span><span class="co">#&gt; Central carbon metabolism in cancer                 Central carbon metabolism in cancer</span></span>
<span><span class="co">#&gt; Protein digestion and absorption                       Protein digestion and absorption</span></span>
<span><span class="co">#&gt; Mineral absorption                                                   Mineral absorption</span></span>
<span><span class="co">#&gt; ABC transporters                                                       ABC transporters</span></span>
<span><span class="co">#&gt; Aminoacyl-tRNA biosynthesis                                 Aminoacyl-tRNA biosynthesis</span></span>
<span><span class="co">#&gt; Alanine, aspartate and glutamate metabolism Alanine, aspartate and glutamate metabolism</span></span>
<span><span class="co">#&gt;                                                                                    NAME</span></span>
<span><span class="co">#&gt; Central carbon metabolism in cancer                 Central carbon metabolism in cancer</span></span>
<span><span class="co">#&gt; Protein digestion and absorption                       Protein digestion and absorption</span></span>
<span><span class="co">#&gt; Mineral absorption                                                   Mineral absorption</span></span>
<span><span class="co">#&gt; ABC transporters                                                       ABC transporters</span></span>
<span><span class="co">#&gt; Aminoacyl-tRNA biosynthesis                                 Aminoacyl-tRNA biosynthesis</span></span>
<span><span class="co">#&gt; Alanine, aspartate and glutamate metabolism Alanine, aspartate and glutamate metabolism</span></span>
<span><span class="co">#&gt;                                             CompoundRatio</span></span>
<span><span class="co">#&gt; Central carbon metabolism in cancer                16/118</span></span>
<span><span class="co">#&gt; Protein digestion and absorption                   15/118</span></span>
<span><span class="co">#&gt; Mineral absorption                                 12/118</span></span>
<span><span class="co">#&gt; ABC transporters                                   22/118</span></span>
<span><span class="co">#&gt; Aminoacyl-tRNA biosynthesis                        13/118</span></span>
<span><span class="co">#&gt; Alanine, aspartate and glutamate metabolism         9/118</span></span>
<span><span class="co">#&gt;                                              BgRatio</span></span>
<span><span class="co">#&gt; Central carbon metabolism in cancer          37/3527</span></span>
<span><span class="co">#&gt; Protein digestion and absorption             47/3527</span></span>
<span><span class="co">#&gt; Mineral absorption                           29/3527</span></span>
<span><span class="co">#&gt; ABC transporters                            139/3527</span></span>
<span><span class="co">#&gt; Aminoacyl-tRNA biosynthesis                  52/3527</span></span>
<span><span class="co">#&gt; Alanine, aspartate and glutamate metabolism  28/3527</span></span>
<span><span class="co">#&gt;                                                   pvalue</span></span>
<span><span class="co">#&gt; Central carbon metabolism in cancer         6.317539e-15</span></span>
<span><span class="co">#&gt; Protein digestion and absorption            9.212369e-12</span></span>
<span><span class="co">#&gt; Mineral absorption                          3.607391e-11</span></span>
<span><span class="co">#&gt; ABC transporters                            4.235413e-10</span></span>
<span><span class="co">#&gt; Aminoacyl-tRNA biosynthesis                 7.164608e-09</span></span>
<span><span class="co">#&gt; Alanine, aspartate and glutamate metabolism 1.566506e-07</span></span>
<span><span class="co">#&gt;                                                 p.adjust</span></span>
<span><span class="co">#&gt; Central carbon metabolism in cancer         7.517872e-13</span></span>
<span><span class="co">#&gt; Protein digestion and absorption            5.481360e-10</span></span>
<span><span class="co">#&gt; Mineral absorption                          1.430932e-09</span></span>
<span><span class="co">#&gt; ABC transporters                            1.260035e-08</span></span>
<span><span class="co">#&gt; Aminoacyl-tRNA biosynthesis                 1.705177e-07</span></span>
<span><span class="co">#&gt; Alanine, aspartate and glutamate metabolism 3.106904e-06</span></span></code></pre></div>
<p>结果：在设置提取差异代谢物阈值后，可以得知ORA结果下有119, 9条通路存在，再根据qvalue卡差异通路即可。</p>
<ul>
<li><p>差异代谢物涉及到的通路</p></li>
<li><p>超级几何检验后得到的统计结果pvalue等</p></li>
</ul>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ORA_bubble</span> <span class="op">&lt;-</span> <span class="fu">plot_enrichment</span><span class="op">(</span></span>
<span>    inputdata <span class="op">=</span> <span class="va">ORA_res</span><span class="op">$</span><span class="va">enrich</span>,</span>
<span>    qval_cutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    topN <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    plot_type <span class="op">=</span> <span class="st">"bubble"</span>,</span>
<span>    enrich_type <span class="op">=</span> <span class="st">"ORA"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">ORA_bubble</span></span></code></pre></div>
<div class="inline-figure"><img src="23-Metabolome-FunctionAnalysis_files/figure-html/unnamed-chunk-9-1.png" width="100%"></div>
<p>结果：</p>
<p>从上述富集通路看，<strong>ABC transporters</strong>可通过代谢<em>Tryptophan</em>产生影响宿主的物质如(该通路涉及到的31个代谢物)</p>
<blockquote>
<p>sucrose/myo-inositol/glycerol/arginine/alanine/sulfate
/heme/uridine/betaine/taurine/maltose/histidine/cystine
/deoxycarnitine/maltotriose/valine/phenylalanine/erythritol
/glutamine/glucose/phosphate/leucine/serine/threonine/urea
/choline/ornithine/glycine/aspartate/hydroxyproline/fructose</p>
</blockquote>
<p>综上，可对富集在该通路的代谢物的上下游基因或酶做进一步研究。</p>
<ul>
<li>GSEA: 所有差异代谢物富集分析结果</li>
</ul>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">GSEA_res</span> <span class="op">&lt;-</span> <span class="fu">get_enrichment</span><span class="op">(</span></span>
<span>  dat <span class="op">=</span> <span class="va">datSignif</span>,</span>
<span>  ref <span class="op">=</span> <span class="va">hsa_kegg_compound</span>,</span>
<span>  group <span class="op">=</span> <span class="va">grp_names</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  direction <span class="op">=</span> <span class="st">"none"</span>,  </span>
<span>  lg2fc_cutoff <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  pval_cutoff <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  qval_cutoff <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  enrich_type <span class="op">=</span> <span class="st">"GSEA"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">GSEA_res</span><span class="op">$</span><span class="va">enrich</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="问题" class="section level2" number="12.8">
<h2>
<span class="header-section-number">12.8</span> 问题<a class="anchor" aria-label="anchor" href="#%E9%97%AE%E9%A2%98"><i class="fas fa-link"></i></a>
</h2>
<p>上述参考数据库是基于human的，而本次数据是人肠道粪便的代谢组，它们大多数是来自于微生物。为了更精确计算富集结果，这里采用<code>MicrobiomeProfiler</code>提供的代谢物参考数据库</p>
<blockquote>
<p>先前有想过把所有微生物涉及到的代谢物和通路的对应关系提取出来，但是太麻烦了，后来找到了<code>MicrobiomeProfiler</code>包，它里面提供微生物代谢组数据库</p>
</blockquote>
<p>只需要对上述<em>get_enrichment</em>函数修改参考数据库即可，但它目前只提供ORA的方法(下方是沟通的邮件对话)。</p>
<p>询问</p>
<blockquote>
<p>Hi，Meijun老师您好，</p>
<p>您开发的MicrobiomeProfiler极大方便了微生物的代谢物等的功能富集分析。作为受益者，对此表示非常感谢，生信领域因为有你们这样优秀的开发者而更加美好。</p>
<p>现在有2个问题想咨询下您：
在KEGG pathway数据库中，不同的物种对应不同的pathway，且每个pathway下又有不同的compound和gene。比如在做人的富集分析的时候，会设置organism = &gt; “hsa”，然后提取对应pathway里面的compound数据构建代谢物和pathway的对应关系表，但看到microbiomeprofiler在代谢物富集分析的时候，用的是KEGG &gt; compound的数据库，该数据是没有物种区分的，这样做是合理的吗？
在microbiomeprofiler富集分析使用的是clusterProfiler的enrichr函数，该方法只能做ORA的分析，像clusterProfiler还提供了GESA的方法，是否后期也会支持该富集分析方法？</p>
</blockquote>
<p>Meijun chen回复</p>
<blockquote>
<p>感谢来信。关于信中提到的两个问题，第一个，由于不同组织来源或者生态环境中的微生物组成及其遗传信息差异很大，此外，需要将整个微生物群落当作一个整体来研究，因此在做微生物富集分析时，我们推荐用户使用自己的背景库（即实验中检测到的全部基因作为universe，差异基因作为query list），因此未提供给用户可供选择的固定背景库；第二个问题，GSEA目前在微生物领域应用较少，我们后续会考虑支持GSEA方法。</p>
</blockquote>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_enrichment2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">dat</span> <span class="op">=</span> <span class="va">datSignif</span>,</span>
<span>  <span class="va">group</span>,</span>
<span>  <span class="va">direction</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="st">"DownRegulated"</span>, <span class="st">"UpRegulated"</span><span class="op">)</span>, <span class="co"># DownRegulated-&gt;1st group; UpRegulated-&gt;2nd group </span></span>
<span>  <span class="va">index_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FoldChange"</span>, <span class="st">"Log2FoldChange"</span>, <span class="st">"VIP"</span>, <span class="st">"CorPvalue"</span>, <span class="st">"Pvalue"</span>, <span class="st">"AdjustedPvalue"</span><span class="op">)</span>,</span>
<span>  <span class="va">index_cutoff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span> </span>
<span>  <span class="co"># dat = datSignif</span></span>
<span>  <span class="co"># group = grp_names[c(1, 4)]</span></span>
<span>  <span class="co"># direction = NULL</span></span>
<span>  <span class="co"># index_names = c("Log2FoldChange", "AdjustedPvalue")</span></span>
<span>  <span class="co"># index_cutoff = c(0, 1)</span></span>
<span>  </span>
<span>  <span class="va">group_collapse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">group</span>, collapse <span class="op">=</span> <span class="st">" vs "</span><span class="op">)</span></span>
<span>  <span class="va">signif_df</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Block2</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_collapse</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">signif_df</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">signif_df</span><span class="op">)</span> <span class="op">==</span> <span class="va">index_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"DA_index1"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">signif_df</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">signif_df</span><span class="op">)</span> <span class="op">==</span> <span class="va">index_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"DA_index2"</span></span>
<span>  </span>
<span>  <span class="va">signif_df_cln</span> <span class="op">&lt;-</span> <span class="va">signif_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">DA_index1</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">index_cutoff</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">DA_index2</span> <span class="op">&lt;</span> <span class="va">index_cutoff</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">KEGG</span> <span class="op">!=</span> <span class="st">"-"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">KEGG</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">signif_df_cln</span><span class="op">$</span><span class="va">KEGG</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\s+\\|\\s+\\w+\\d+"</span>, <span class="st">""</span>, <span class="va">signif_df_cln</span><span class="op">$</span><span class="va">KEGG</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">signif_df_cln</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Beyond these thresholds, no significant metabolites were selected"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">signif_temp</span> <span class="op">&lt;-</span> <span class="va">signif_df_cln</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FeatureID</span>, <span class="va">Block2</span>, <span class="va">KEGG</span>, <span class="va">BIOCHEMICAL</span>, <span class="va">DA_index1</span>, <span class="va">DA_index2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">DA_index1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">index_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="st">"Log2FoldChange"</span>, <span class="va">direction</span> <span class="op">==</span> <span class="st">"DownRegulated"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">direction</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inputdata</span> <span class="op">&lt;-</span> <span class="va">signif_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">DA_index1</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">index_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="st">"Log2FoldChange"</span>, <span class="va">direction</span> <span class="op">==</span> <span class="st">"UpRegulated"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">direction</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inputdata</span> <span class="op">&lt;-</span> <span class="va">signif_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">DA_index1</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">index_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="st">"Log2FoldChange"</span>, <span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">direction</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inputdata</span> <span class="op">&lt;-</span> <span class="va">signif_temp</span>   </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">inputdata</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Beyond these thresholds, no significant metabolites were selected when using direction"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>  </span>
<span>  </span>
<span>  <span class="co"># inputdata$cpd_ID &lt;- paste0("PW_", inputdata$cpd_ID)</span></span>
<span>  <span class="co"># bitr_smpdb(inputdata$cpd_ID, from_Type = "KEGG.ID", to_Type = "HMDB.ID")</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeProfiler</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeProfiler/man/enrichMBKEGG.html">enrichMBKEGG</a></span><span class="op">(</span></span>
<span>            metabo_list <span class="op">=</span> <span class="va">inputdata</span><span class="op">$</span><span class="va">KEGG</span>,</span>
<span>            pvalueCutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>            pAdjustMethod <span class="op">=</span> <span class="st">"BH"</span>,</span>
<span>            minGSSize <span class="op">=</span> <span class="fl">10</span>,</span>
<span>            maxGSSize <span class="op">=</span> <span class="fl">500</span>,</span>
<span>            qvalueCutoff <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">@</span><span class="va">result</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">EA_res</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">@</span><span class="va">result</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Description</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Group <span class="op">=</span> <span class="va">group_collapse</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>CompoundRatio <span class="op">=</span> <span class="va">GeneRatio</span>,</span>
<span>                    CompoundID <span class="op">=</span> <span class="va">geneID</span>,</span>
<span>                    NAME <span class="op">=</span> <span class="va">Description</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">NAME</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">EA_res</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">inputdata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">inputdata</span><span class="op">)</span> <span class="op">==</span> <span class="st">"DA_index1"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">index_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">inputdata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">inputdata</span><span class="op">)</span> <span class="op">==</span> <span class="st">"DA_index2"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">index_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>  </span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">EA_res</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">EA_res</span><span class="op">$</span><span class="va">CompoundName</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">EA_res</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">compound_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">EA_res</span><span class="op">$</span><span class="va">CompoundID</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\\/"</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">CompoundName</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">compound_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">inputdata</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="kw">if</span> <span class="op">(</span><span class="va">compound_list</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">==</span> <span class="va">inputdata</span><span class="op">$</span><span class="va">KEGG</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">CompoundName</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">CompoundName</span>, <span class="va">inputdata</span><span class="op">$</span><span class="va">BIOCHEMICAL</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">EA_res</span><span class="op">$</span><span class="va">CompoundName</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">CompoundName</span>, collapse <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">res_score</span> <span class="op">&lt;-</span> <span class="va">EA_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Group</span>, <span class="va">ID</span>, <span class="va">NAME</span>, </span>
<span>                    <span class="va">CompoundRatio</span>, <span class="va">BgRatio</span>, </span>
<span>                    <span class="va">pvalue</span>, <span class="va">p.adjust</span>, <span class="va">qvalue</span>, </span>
<span>                    <span class="va">CompoundName</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">res_score</span> <span class="op">&lt;-</span> <span class="va">EA_res</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">inputdata</span>,</span>
<span>              enrich <span class="op">=</span> <span class="va">res_score</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ORA_res</span> <span class="op">&lt;-</span> <span class="fu">get_enrichment2</span><span class="op">(</span></span>
<span>  dat <span class="op">=</span> <span class="va">datSignif</span>,</span>
<span>  group <span class="op">=</span> <span class="va">grp_names</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  direction <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  index_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Log2FoldChange"</span>, <span class="st">"AdjustedPvalue"</span><span class="op">)</span>,</span>
<span>  index_cutoff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ORA_res</span><span class="op">$</span><span class="va">enrich</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   Group       ID</span></span>
<span><span class="co">#&gt; map05230 None vs Severe map05230</span></span>
<span><span class="co">#&gt; map01060 None vs Severe map01060</span></span>
<span><span class="co">#&gt; map01230 None vs Severe map01230</span></span>
<span><span class="co">#&gt; map04974 None vs Severe map04974</span></span>
<span><span class="co">#&gt; map02010 None vs Severe map02010</span></span>
<span><span class="co">#&gt; map04978 None vs Severe map04978</span></span>
<span><span class="co">#&gt;                                                 NAME</span></span>
<span><span class="co">#&gt; map05230         Central carbon metabolism in cancer</span></span>
<span><span class="co">#&gt; map01060 Biosynthesis of plant secondary metabolites</span></span>
<span><span class="co">#&gt; map01230                 Biosynthesis of amino acids</span></span>
<span><span class="co">#&gt; map04974            Protein digestion and absorption</span></span>
<span><span class="co">#&gt; map02010                            ABC transporters</span></span>
<span><span class="co">#&gt; map04978                          Mineral absorption</span></span>
<span><span class="co">#&gt;          CompoundRatio  BgRatio       pvalue</span></span>
<span><span class="co">#&gt; map05230        22/190  37/6390 4.819405e-25</span></span>
<span><span class="co">#&gt; map01060        35/190 141/6390 1.760987e-23</span></span>
<span><span class="co">#&gt; map01230        30/190 128/6390 2.040244e-19</span></span>
<span><span class="co">#&gt; map04974        20/190  47/6390 5.191989e-19</span></span>
<span><span class="co">#&gt; map02010        30/190 138/6390 2.029215e-18</span></span>
<span><span class="co">#&gt; map04978        14/190  29/6390 1.374612e-14</span></span></code></pre></div>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ORA_bubble</span> <span class="op">&lt;-</span> <span class="fu">plot_enrichment</span><span class="op">(</span></span>
<span>    inputdata <span class="op">=</span> <span class="va">ORA_res</span><span class="op">$</span><span class="va">enrich</span>,</span>
<span>    qval_cutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    topN <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    plot_type <span class="op">=</span> <span class="st">"bubble"</span>,</span>
<span>    enrich_type <span class="op">=</span> <span class="st">"ORA"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">ORA_bubble</span></span></code></pre></div>
<div class="inline-figure"><img src="23-Metabolome-FunctionAnalysis_files/figure-html/unnamed-chunk-11-1.png" width="100%"></div>
</div>
<div id="ssgsea-single-sample-gene-set-enrichment-analysis" class="section level2" number="12.9">
<h2>
<span class="header-section-number">12.9</span> ssGSEA: Single sample gene set enrichment analysis<a class="anchor" aria-label="anchor" href="#ssgsea-single-sample-gene-set-enrichment-analysis"><i class="fas fa-link"></i></a>
</h2>
<p>单样本基因富集分析ssGSEA是另一种寻找富集分析通路的办法，相比将不同表型的样本所有基因混合在一起做富集分析的GSEA方法，ssGSEA通过计算每个样本的富集得分，然后通过一些差异分析方法比较通路在组间的异同。</p>
<blockquote>
<p>原理</p>
<p>ssGSEA是一种常用于免疫细胞浸润分析的方法。该方法通过将每个样本的基因表达数据与特定的基因集（免疫细胞基因集）进行比较，来估计该基因集在该样本中的相对富集程度。在免疫细胞浸润分析中，我们可以使用ssGSEA来估计每个样本中不同免疫细胞类型的相对丰度。</p>
<p>具体而言，ssGSEA首先将所有基因按照其表达量从大到小进行排序，并计算在某个基因集内，基因表达量较高的基因的累积分布函数。这个累积分布函数被称为基因集富集得分（gene set enrichment score，GSE）。然后，对于每个样本，将该样本中的所有基因的表达量按照从大到小的顺序排列，计算每个位置上所对应的基因集富集得分。最后，将这些位置上的得分进行平均或加权平均，得到该样本在该基因集上的ssGSEA得分，用于估计该样本中该免疫细胞类型的相对丰度。</p>
</blockquote>
<div id="加载r包-9" class="section level3" number="12.9.1">
<h3>
<span class="header-section-number">12.9.1</span> 加载R包<a class="anchor" aria-label="anchor" href="#%E5%8A%A0%E8%BD%BDr%E5%8C%85-9"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="st">"GSVA"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Install this package if it isn't installed yet</span></span>
<span>  <span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html">install</a></span><span class="op">(</span><span class="st">"GSVA"</span>, update <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rcastelo/GSVA">GSVA</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div id="导入数据-7" class="section level3" number="12.9.2">
<h3>
<span class="header-section-number">12.9.2</span> 导入数据<a class="anchor" aria-label="anchor" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE-7"><i class="fas fa-link"></i></a>
</h3>
<p>对数据<a href="https://github.com/HuaZou/DraftNotes/blob/main/InputData/Zeybel-2022/OmicsDataSet-Zeybel%20et%20al.%20-%202022.xlsx">OmicsDataSet-Zeybel et al. - 2022.xlsx</a>处理后生成的，可参考数据预处理章节。</p>
<blockquote>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">se_scale</span>, <span class="st">"./InputData/result/QC/se_scale.RDS"</span>, compress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</blockquote>
<ul>
<li>se_scale.RDS用于计算单个样本的富集打分</li>
</ul>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"./InputData/result/QC/se_scale.RDS"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="准备代谢组文件" class="section level3" number="12.9.3">
<h3>
<span class="header-section-number">12.9.3</span> 准备代谢组文件<a class="anchor" aria-label="anchor" href="#%E5%87%86%E5%A4%87%E4%BB%A3%E8%B0%A2%E7%BB%84%E6%96%87%E4%BB%B6"><i class="fas fa-link"></i></a>
</h3>
<p>以KEGG ID作为代谢物表达谱的行名</p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phenotype</span> <span class="op">&lt;-</span> <span class="fu">SummarizedExperiment</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">colData</a></span><span class="op">(</span><span class="va">se_scale</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">profile</span> <span class="op">&lt;-</span> <span class="fu">SummarizedExperiment</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">assay</a></span><span class="op">(</span><span class="va">se_scale</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature</span> <span class="op">&lt;-</span> <span class="fu">SummarizedExperiment</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">rowData</a></span><span class="op">(</span><span class="va">se_scale</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature</span><span class="op">$</span><span class="va">KEGG</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\s+\\|\\s+\\w+\\d+"</span>, <span class="st">""</span>, <span class="va">feature</span><span class="op">$</span><span class="va">KEGG</span><span class="op">)</span></span>
<span><span class="va">feature</span><span class="op">$</span><span class="va">KEGG</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">",\\S+"</span>, <span class="st">""</span>, <span class="va">feature</span><span class="op">$</span><span class="va">KEGG</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature_cln</span> <span class="op">&lt;-</span> <span class="va">feature</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">KEGG</span> <span class="op">!=</span> <span class="st">"-"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">KEGG</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">metabolitesID</span>, <span class="va">KEGG</span><span class="op">)</span></span>
<span></span>
<span><span class="va">unique_KEGGID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">feature_cln</span><span class="op">$</span><span class="va">KEGG</span><span class="op">)</span></span>
<span><span class="va">feature_final</span> <span class="op">&lt;-</span> <span class="va">feature_cln</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/pmatch.html">pmatch</a></span><span class="op">(</span><span class="va">unique_KEGGID</span>, <span class="va">feature_cln</span><span class="op">$</span><span class="va">KEGG</span><span class="op">)</span>, , <span class="cn">F</span><span class="op">]</span></span>
<span></span>
<span><span class="va">profile_final</span> <span class="op">&lt;-</span> <span class="va">profile</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/pmatch.html">pmatch</a></span><span class="op">(</span><span class="va">feature_final</span><span class="op">$</span><span class="va">metabolitesID</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">profile</span><span class="op">)</span><span class="op">)</span>, , <span class="cn">F</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">profile_final</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">feature_final</span><span class="op">$</span><span class="va">KEGG</span></span></code></pre></div>
</div>
<div id="准备kegg配置文件" class="section level3" number="12.9.4">
<h3>
<span class="header-section-number">12.9.4</span> 准备KEGG配置文件<a class="anchor" aria-label="anchor" href="#%E5%87%86%E5%A4%87kegg%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><i class="fas fa-link"></i></a>
</h3>
<p>准备基因富集数据集，一般可以用<strong>The Molecular Signatures Database (MSigDB)</strong>，但它好像没有提供代谢组对应的数据集。</p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hallmark_gene_sets</span> <span class="op">&lt;-</span> <span class="fu">msigdbr</span><span class="fu">::</span><span class="fu">msigdbr</span><span class="op">(</span></span>
<span>  species <span class="op">=</span> <span class="st">"Homo sapiens"</span>, <span class="co"># Can change this to what species you need</span></span>
<span>  category <span class="op">=</span> <span class="st">"H"</span> <span class="co"># Only hallmark gene sets</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>方法1: 本文采用从KEGG官网下载的数据转换成gsva包所需要的数据库文件格式（每一个通路作为一个list对象，该list元素是代谢物名字）。</p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hsa_kegg_compound</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"./InputData/result/KEGG/KEGG_COMPOUND_PATHWAY_hsa.csv"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">kegg_compound_gsva_list</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span></span>
<span>  <span class="va">hsa_kegg_compound</span><span class="op">$</span><span class="va">COMPOUND</span>,</span>
<span>  <span class="va">hsa_kegg_compound</span><span class="op">$</span><span class="va">PATHWAY_MAP</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">kegg_compound_gsva_list</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; $`ABC transporters`</span></span>
<span><span class="co">#&gt;   [1] "C00009" "C00025" "C00031" "C00032" "C00034" "C00037"</span></span>
<span><span class="co">#&gt;   [7] "C00038" "C00041" "C00047" "C00049" "C00051" "C00059"</span></span>
<span><span class="co">#&gt;  [13] "C00062" "C00064" "C00065" "C00070" "C00077" "C00079"</span></span>
<span><span class="co">#&gt;  [19] "C00086" "C00088" "C00089" "C00093" "C00095" "C00098"</span></span>
<span><span class="co">#&gt;  [25] "C00107" "C00114" "C00116" "C00120" "C00121" "C00123"</span></span>
<span><span class="co">#&gt;  [31] "C00134" "C00135" "C00137" "C00140" "C00148" "C00151"</span></span>
<span><span class="co">#&gt;  [37] "C00159" "C00175" "C00181" "C00183" "C00185" "C00188"</span></span>
<span><span class="co">#&gt;  [43] "C00208" "C00212" "C00243" "C00244" "C00245" "C00255"</span></span>
<span><span class="co">#&gt;  [49] "C00259" "C00288" "C00291" "C00294" "C00299" "C00315"</span></span>
<span><span class="co">#&gt;  [55] "C00320" "C00330" "C00333" "C00338" "C00378" "C00379"</span></span>
<span><span class="co">#&gt;  [61] "C00387" "C00392" "C00407" "C00430" "C00470" "C00475"</span></span>
<span><span class="co">#&gt;  [67] "C00487" "C00491" "C00492" "C00503" "C00526" "C00559"</span></span>
<span><span class="co">#&gt;  [73] "C00719" "C00794" "C00855" "C00865" "C00881" "C00919"</span></span>
<span><span class="co">#&gt;  [79] "C00973" "C01083" "C01153" "C01157" "C01177" "C01181"</span></span>
<span><span class="co">#&gt;  [85] "C01279" "C01330" "C01417" "C01487" "C01606" "C01630"</span></span>
<span><span class="co">#&gt;  [91] "C01667" "C01674" "C01682" "C01684" "C01762" "C01834"</span></span>
<span><span class="co">#&gt;  [97] "C01835" "C01935" "C01946" "C02160" "C02273" "C03557"</span></span>
<span><span class="co">#&gt; [103] "C03611" "C03619" "C04114" "C04137" "C05349" "C05402"</span></span>
<span><span class="co">#&gt; [109] "C05512" "C05776" "C06227" "C06229" "C06230" "C06232"</span></span>
<span><span class="co">#&gt; [115] "C06687" "C06705" "C06706" "C06707" "C06767" "C07662"</span></span>
<span><span class="co">#&gt; [121] "C07663" "C11612" "C13768" "C14818" "C14819" "C15521"</span></span>
<span><span class="co">#&gt; [127] "C15719" "C16421" "C16692" "C19609" "C19872" "C20570"</span></span>
<span><span class="co">#&gt; [133] "C20571" "C20572" "C20573" "C20679" "C21066" "C22040"</span></span>
<span><span class="co">#&gt; [139] "G00457"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`Acute myeloid leukemia`</span></span>
<span><span class="co">#&gt; [1] "C05981"</span></span></code></pre></div>
<p>方法2: 采用<code>massdatabase</code>包提供的12个在线数据库下载物种的化合物/通路数据，并将其转换成数据框格式。它主要提供了</p>
<ul>
<li><p>download_kegg_pathway：下载KEGG通路函数</p></li>
<li><p>read_kegg_pathway：读取KEGG通路</p></li>
<li><p>convert_kegg2metpath：转换KEGG通路</p></li>
</ul>
<p>先前下载代码有使用过request_kegg_pathway函数，获取对应物种的KEGG信息，KEGG的物种简称见<a href="https://www.genome.jp/kegg/catalog/org_list.html">KEGG Organisms: Complete Genomes</a>。本文使用<em>hsa</em> (Homo sapiens (human))。</p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="st">"massdatabase"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"tidymass/massdatabase"</span>, dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymass/massdatabase">massdatabase</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/massdatabase/man/download_kegg_pathway.html">download_kegg_pathway</a></span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="st">"./InputData/KEGG/hsa_KEGG"</span>,</span>
<span>  sleep <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  organism <span class="op">=</span> <span class="st">"hsa"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">KEGG_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/massdatabase/man/read_kegg_pathway.html">read_kegg_pathway</a></span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="st">"./InputData/KEGG/hsa_KEGG"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">KEGG_pathway_database</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/massdatabase/man/convert_kegg2metpath.html">convert_kegg2metpath</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">KEGG_data</span>, </span>
<span>  path <span class="op">=</span> <span class="st">"./InputData/KEGG/hsa_KEGG"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">KEGG_pathway_database</span></span></code></pre></div>
<ul>
<li>KEGG通路和基因关系 (包含pahtwya对应的module信息)</li>
</ul>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">KEGG_gene_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">KEGG_data</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">pathID</span> <span class="op">&lt;-</span>  <span class="va">KEGG_data</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pathway_id</span></span>
<span>  <span class="va">pathName</span> <span class="op">&lt;-</span> <span class="va">KEGG_data</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pathway_name</span> </span>
<span>  <span class="va">geneList</span> <span class="op">&lt;-</span> <span class="va">KEGG_data</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">gene_list</span></span>
<span>  <span class="va">pathClass</span> <span class="op">&lt;-</span> <span class="va">KEGG_data</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pathway_class</span></span>
<span>  <span class="va">pathModule</span> <span class="op">&lt;-</span> <span class="va">KEGG_data</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">related_module</span></span>
<span>  <span class="va">describtion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">KEGG_data</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">describtion</span>, collapse <span class="op">=</span> <span class="st">";"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">geneList</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">next</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">geneList</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Gene.name</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Gene.symbol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">Gene.name</span>, <span class="st">";"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>KO.ID <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">Gene.name</span>, <span class="st">"KO:K\\d+"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>EC.ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"[EC"</span>, <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">Gene.name</span>, <span class="st">"EC"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>EC.ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">EC.ID</span> <span class="op">==</span> <span class="st">"[ECNA"</span>, <span class="cn">NA</span>, <span class="va">EC.ID</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pathway_id <span class="op">=</span> <span class="va">pathID</span>,</span>
<span>                    pathway_name <span class="op">=</span> <span class="va">pathName</span><span class="op">)</span>    </span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">describtion</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>describtion <span class="op">=</span> <span class="va">describtion</span><span class="op">)</span>       </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>describtion <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>       </span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">pathClass</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pathway_class <span class="op">=</span> <span class="va">pathClass</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">pathway_class</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pathway_level2"</span>, <span class="st">"pathway_level1"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">';'</span>, remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>      </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>       <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pathway_class <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                      pathway_level1 <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                      pathway_level2 <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>      </span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pathModule</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span></span>
<span>        <span class="va">pathModule</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pathway_id <span class="op">=</span> <span class="va">pathID</span><span class="op">)</span>,</span>
<span>        by <span class="op">=</span> <span class="st">"pathway_id"</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pathway_id</span>, <span class="va">pathway_level1</span>, <span class="va">pathway_level2</span>, <span class="va">Module.ID</span>, <span class="va">Module.name</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>     </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>       <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Module.ID <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                      Module.name <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>      </span>
<span>    <span class="op">}</span>    </span>
<span>    </span>
<span>    <span class="va">KEGG_gene_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">KEGG_gene_path</span>, <span class="va">temp</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<ul>
<li>KEGG通路和代谢物关系 (包含pahtwya对应的module信息)</li>
</ul>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">KEGG_metabolite_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">KEGG_data</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">pathID</span> <span class="op">&lt;-</span>  <span class="va">KEGG_data</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pathway_id</span></span>
<span>  <span class="va">pathName</span> <span class="op">&lt;-</span> <span class="va">KEGG_data</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pathway_name</span> </span>
<span>  <span class="va">compoundList</span> <span class="op">&lt;-</span> <span class="va">KEGG_data</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">compound_list</span></span>
<span>  <span class="va">pathClass</span> <span class="op">&lt;-</span> <span class="va">KEGG_data</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pathway_class</span></span>
<span>  <span class="va">pathModule</span> <span class="op">&lt;-</span> <span class="va">KEGG_data</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">related_module</span></span>
<span>  <span class="va">describtion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">KEGG_data</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">describtion</span>, collapse <span class="op">=</span> <span class="st">";"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">compoundList</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">next</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">compoundList</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pathway_id <span class="op">=</span> <span class="va">pathID</span>,</span>
<span>                    pathway_name <span class="op">=</span> <span class="va">pathName</span><span class="op">)</span>    </span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">describtion</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>describtion <span class="op">=</span> <span class="va">describtion</span><span class="op">)</span>       </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>describtion <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>       </span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">pathClass</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pathway_class <span class="op">=</span> <span class="va">pathClass</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">pathway_class</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pathway_level2"</span>, <span class="st">"pathway_level1"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">';'</span>, remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>      </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>       <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pathway_class <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                      pathway_level1 <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                      pathway_level2 <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>      </span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pathModule</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span></span>
<span>        <span class="va">pathModule</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pathway_id <span class="op">=</span> <span class="va">pathID</span><span class="op">)</span>,</span>
<span>        by <span class="op">=</span> <span class="st">"pathway_id"</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pathway_id</span>, <span class="va">pathway_level1</span>, <span class="va">pathway_level2</span>, <span class="va">Module.ID</span>, <span class="va">Module.name</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>     </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>       <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Module.ID <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                      Module.name <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>      </span>
<span>    <span class="op">}</span>    </span>
<span>    </span>
<span>    <span class="va">KEGG_metabolite_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">KEGG_metabolite_path</span>, <span class="va">temp</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div id="计算单个样本的gsea" class="section level3" number="12.9.5">
<h3>
<span class="header-section-number">12.9.5</span> 计算单个样本的GSEA<a class="anchor" aria-label="anchor" href="#%E8%AE%A1%E7%AE%97%E5%8D%95%E4%B8%AA%E6%A0%B7%E6%9C%AC%E7%9A%84gsea"><i class="fas fa-link"></i></a>
</h3>
<p><code>gsva</code>函数提供了四种计算方法，详情见<code><a href="https://rdrr.io/pkg/GSVA/man/gsva.html">?GSVA::gsva</a></code>。</p>
<ul>
<li><p>gsva (Hänzelmann et al, 2013): GSVA拟合一个模型，并根据相对于样本分布的表达水平对基因进行排序。计算的通路水平分数是一种询问基因集中的基因与该基因集中以外的基因相比如何变化的方法。</p></li>
<li><p>ssgsea (Barbie et al, 2009)：单样本GSEA (ssGSEA)，基因集富集分析(GSEA)的扩展，计算样品和基因集的每对单独的富集分数。每个ssGSEA富集分数代表了一个特定基因集中的基因在一个样本中协调上调或下调的程度。</p></li>
<li><p>zscore (Lee et al, 2008)</p></li>
<li><p>plage (Tomfohr et al, 2005)</p></li>
</ul>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gsva_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/GSVA/man/gsva.html">gsva</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">profile_final</span><span class="op">)</span>,</span>
<span>  <span class="va">kegg_compound_gsva_list</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"gsva"</span>,</span>
<span>  kcdf <span class="op">=</span> <span class="st">"Gaussian"</span>,</span>
<span>  min.sz <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  max.sz <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  mx.diff <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">gsva_results</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                            P101001</span></span>
<span><span class="co">#&gt; ABC transporters                        -0.1969847</span></span>
<span><span class="co">#&gt; Aminoacyl-tRNA biosynthesis             -0.3747325</span></span>
<span><span class="co">#&gt; Bile secretion                           0.1317401</span></span>
<span><span class="co">#&gt; Biosynthesis of unsaturated fatty acids  0.3425360</span></span>
<span><span class="co">#&gt; Central carbon metabolism in cancer     -0.3105238</span></span>
<span><span class="co">#&gt; D-Amino acid metabolism                 -0.2673661</span></span>
<span><span class="co">#&gt;                                            P101003</span></span>
<span><span class="co">#&gt; ABC transporters                        -0.3853362</span></span>
<span><span class="co">#&gt; Aminoacyl-tRNA biosynthesis             -0.2669277</span></span>
<span><span class="co">#&gt; Bile secretion                           0.2239382</span></span>
<span><span class="co">#&gt; Biosynthesis of unsaturated fatty acids  0.6966145</span></span>
<span><span class="co">#&gt; Central carbon metabolism in cancer     -0.3902289</span></span>
<span><span class="co">#&gt; D-Amino acid metabolism                 -0.1233907</span></span>
<span><span class="co">#&gt;                                             P101004</span></span>
<span><span class="co">#&gt; ABC transporters                         0.07454968</span></span>
<span><span class="co">#&gt; Aminoacyl-tRNA biosynthesis              0.20151569</span></span>
<span><span class="co">#&gt; Bile secretion                          -0.14599557</span></span>
<span><span class="co">#&gt; Biosynthesis of unsaturated fatty acids  0.29420257</span></span>
<span><span class="co">#&gt; Central carbon metabolism in cancer      0.17196637</span></span>
<span><span class="co">#&gt; D-Amino acid metabolism                  0.06324261</span></span></code></pre></div>
</div>
<div id="可视化结果-1" class="section level3" number="12.9.6">
<h3>
<span class="header-section-number">12.9.6</span> 可视化结果<a class="anchor" aria-label="anchor" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E7%BB%93%E6%9E%9C-1"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">annot_df</span> <span class="op">&lt;-</span> <span class="va">phenotype</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>    <span class="va">LiverFatClass</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="st">"TempRow"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">LiverFatClass</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>LiverFatClass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">LiverFatClass</span>,</span>
<span>                                       levels <span class="op">=</span> <span class="va">grp_names</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">column_to_rownames</a></span><span class="op">(</span><span class="st">"TempRow"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plotdata</span> <span class="op">&lt;-</span> <span class="va">gsva_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">annot_df</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">pheatmap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">pheatmap</a></span><span class="op">(</span></span>
<span>  <span class="va">plotdata</span>,</span>
<span>  annotation_col <span class="op">=</span> <span class="va">annot_df</span>,</span>
<span>  show_colnames <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cluster_cols <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  fontsize_row <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  cellwidth <span class="op">=</span> <span class="fl">7</span>,</span>
<span>  cellheight <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="23-Metabolome-FunctionAnalysis_files/figure-html/unnamed-chunk-18-1.png" width="100%"></div>
<p>结果：</p>
<ul>
<li>ssgsva计算出8条通路，它们的富集得分变化用热图展示，也可以做差异检验。</li>
</ul>
</div>
<div id="箱线图展示结果" class="section level3" number="12.9.7">
<h3>
<span class="header-section-number">12.9.7</span> 箱线图展示结果<a class="anchor" aria-label="anchor" href="#%E7%AE%B1%E7%BA%BF%E5%9B%BE%E5%B1%95%E7%A4%BA%E7%BB%93%E6%9E%9C"><i class="fas fa-link"></i></a>
</h3>
<p>除了热图展示外，还可以用更为直观的箱线图展示并加上差异分析结果。</p>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">get_topN_boxplot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">x</span>,</span>
<span>    <span class="va">y</span>,</span>
<span>    <span class="va">features</span>,</span>
<span>    <span class="va">group</span>,</span>
<span>    <span class="va">group_names</span> <span class="op">=</span> <span class="va">grp_names</span>,</span>
<span>    <span class="va">group_colors</span> <span class="op">=</span> <span class="va">grp_colors</span>,</span>
<span>    <span class="va">dotsize</span> <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span> </span>
<span>  <span class="co"># x = phenotype</span></span>
<span>  <span class="co"># y = gsva_results  </span></span>
<span>  <span class="co"># features = c("ABC transporters")</span></span>
<span>  <span class="co"># group = "LiverFatClass"</span></span>
<span>  <span class="co"># group_names = grp_names[1:2]</span></span>
<span>  <span class="co"># group_colors = grp_colors[1:2]</span></span>
<span>  <span class="co"># dotsize = 1.2</span></span>
<span></span>
<span>  <span class="co"># group</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="va">group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Group_new"</span></span>
<span>  <span class="va">phen</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Group_new</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Group_new</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="st">"TempRowNames"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># profile</span></span>
<span>  <span class="va">prof</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">features</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># merge phenotype and profile</span></span>
<span>  <span class="va">feature_merge</span> <span class="op">&lt;-</span> <span class="va">prof</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="st">"TempRowNames"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"Feature"</span>, value <span class="op">=</span> <span class="st">"Abundance"</span>, <span class="op">-</span><span class="va">TempRowNames</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># dplyr::inner_join(feature, by = c("Feature" = "TempRowNames")) %&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Feature_new <span class="op">=</span> <span class="va">Feature</span><span class="op">)</span> </span>
<span></span>
<span>  <span class="co"># ordering feature</span></span>
<span>  <span class="va">feature_merge</span><span class="op">$</span><span class="va">Feature</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">feature_merge</span><span class="op">$</span><span class="va">Feature</span>, levels <span class="op">=</span> <span class="va">features</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">match_order_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/pmatch.html">pmatch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">phen</span><span class="op">$</span><span class="va">Group_new</span><span class="op">)</span>, <span class="va">group_names</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span>  <span class="va">group_names_new</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="va">match_order_index</span><span class="op">]</span></span>
<span>  <span class="va">group_colors_new</span> <span class="op">&lt;-</span> <span class="va">group_colors</span><span class="op">[</span><span class="va">match_order_index</span><span class="op">]</span>   </span>
<span>  </span>
<span>  <span class="va">mdat</span> <span class="op">&lt;-</span> <span class="va">phen</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">feature_merge</span>, by <span class="op">=</span> <span class="st">"TempRowNames"</span><span class="op">)</span></span>
<span>  <span class="va">mdat</span><span class="op">$</span><span class="va">Group_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">mdat</span><span class="op">$</span><span class="va">Group_new</span>, levels <span class="op">=</span> <span class="va">group_names_new</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># comparison list</span></span>
<span>  <span class="va">cmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">num</span> <span class="op">&lt;-</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/combn.html">combn</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">group_names_new</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">num</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">cmp</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">num</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">pl</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mdat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Group_new</span>, y <span class="op">=</span> <span class="va">Abundance</span>, fill <span class="op">=</span> <span class="va">Group_new</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">stat_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">Group_new</span><span class="op">)</span>, geom <span class="op">=</span> <span class="st">"errorbar"</span>, width <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">.4</span>, outlier.shape <span class="op">=</span> <span class="fl">3</span>, outlier.size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/stat_compare_means.html">stat_compare_means</a></span><span class="op">(</span>comparisons <span class="op">=</span> <span class="va">cmp</span>,</span>
<span>                                 method <span class="op">=</span> <span class="st">"wilcox.test"</span>,</span>
<span>                                 hide.ns <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_dotplot.html">geom_dotplot</a></span><span class="op">(</span>binaxis <span class="op">=</span> <span class="st">"y"</span>, stackdir <span class="op">=</span> <span class="st">"center"</span>,</span>
<span>                 stackratio <span class="op">=</span> <span class="fl">1.5</span>, dotsize <span class="op">=</span> <span class="va">dotsize</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">group_colors_new</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">group_colors_new</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op">(</span>mult <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">"Intensity (metabolites expression)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span>, fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span>facets <span class="op">=</span> <span class="st">"Feature_new"</span>, scales <span class="op">=</span> <span class="st">"free"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, color <span class="op">=</span> <span class="st">"black"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>            axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>            text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">9</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>            strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">9</span>, color <span class="op">=</span> <span class="st">"black"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>            panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>            strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pl</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="fu">get_topN_boxplot</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">phenotype</span>,</span>
<span>  y <span class="op">=</span> <span class="va">gsva_results</span>, </span>
<span>  features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">gsva_results</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="co">#c("Bile secretion", "ABC transporters")</span></span>
<span>  group <span class="op">=</span> <span class="st">"LiverFatClass"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="va">grp_names</span>,</span>
<span>  group_colors <span class="op">=</span> <span class="va">grp_colors</span>,</span>
<span>  dotsize <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="23-Metabolome-FunctionAnalysis_files/figure-html/unnamed-chunk-19-1.png" width="100%"></div>
</div>
</div>
<div id="session-info-4" class="section level2" number="12.10">
<h2>
<span class="header-section-number">12.10</span> Session info<a class="anchor" aria-label="anchor" href="#session-info-4"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://r-lib.github.io/sessioninfo/reference/session_info.html">session_info</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; ─ Session info ───────────────────────────────────────────</span></span>
<span><span class="co">#&gt;  setting  value</span></span>
<span><span class="co">#&gt;  version  R version 4.3.1 (2023-06-16)</span></span>
<span><span class="co">#&gt;  os       macOS Monterey 12.2.1</span></span>
<span><span class="co">#&gt;  system   x86_64, darwin20</span></span>
<span><span class="co">#&gt;  ui       X11</span></span>
<span><span class="co">#&gt;  language (EN)</span></span>
<span><span class="co">#&gt;  collate  en_US.UTF-8</span></span>
<span><span class="co">#&gt;  ctype    en_US.UTF-8</span></span>
<span><span class="co">#&gt;  tz       Asia/Shanghai</span></span>
<span><span class="co">#&gt;  date     2024-02-06</span></span>
<span><span class="co">#&gt;  pandoc   3.1.3 @ /Users/zouhua/opt/anaconda3/bin/ (via rmarkdown)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ─ Packages ───────────────────────────────────────────────</span></span>
<span><span class="co">#&gt;  package              * version     date (UTC) lib source</span></span>
<span><span class="co">#&gt;  abind                  1.4-5       2016-07-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  affy                   1.80.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  affyio                 1.72.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  annotate               1.80.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  AnnotationDbi          1.64.1      2023-11-03 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  ape                    5.7-1       2023-03-13 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  aplot                  0.2.2       2023-10-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  attempt                0.3.1       2020-05-03 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  backports              1.4.1       2021-12-13 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  beachmat               2.18.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  Biobase              * 2.62.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  BiocGenerics         * 0.48.1      2023-11-01 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  BiocManager            1.30.22     2023-08-08 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  BiocParallel           1.36.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  BiocSingular           1.18.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  Biostrings             2.70.2      2024-01-28 [1] Bioconductor 3.18 (R 4.3.2)</span></span>
<span><span class="co">#&gt;  bit                    4.0.5       2022-11-15 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  bit64                  4.0.5       2020-08-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  bitops                 1.0-7       2021-04-24 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  blob                   1.2.4       2023-03-17 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  bookdown               0.37        2023-12-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  broom                  1.0.5       2023-06-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  bslib                  0.6.1       2023-11-28 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  cachem                 1.0.8       2023-05-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  car                    3.1-2       2023-03-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  carData                3.0-5       2022-01-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  cellranger             1.1.0       2016-07-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  circlize               0.4.15      2022-05-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  cli                    3.6.2       2023-12-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  clue                   0.3-65      2023-09-23 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  cluster                2.1.4       2022-08-22 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  clusterProfiler      * 4.10.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  codetools              0.2-19      2023-02-01 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  colorspace             2.1-0       2023-01-23 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ComplexHeatmap         2.18.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  config                 0.3.2       2023-08-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  cowplot                1.1.3       2024-01-22 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  crayon                 1.5.2       2022-09-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  curl                   5.2.0       2023-12-08 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  data.table             1.15.0      2024-01-30 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  DBI                    1.2.1       2024-01-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  DelayedArray           0.28.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  DelayedMatrixStats     1.24.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  devtools               2.4.5       2022-10-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  digest                 0.6.34      2024-01-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  doParallel             1.0.17      2022-02-07 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  DOSE                   3.28.2      2023-12-10 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  downlit                0.4.3       2023-06-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  dplyr                * 1.1.4       2023-11-17 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  DT                     0.31        2023-12-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ellipsis               0.3.2       2021-04-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  enrichplot             1.22.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  evaluate               0.23        2023-11-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  fansi                  1.0.6       2023-12-08 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  farver                 2.1.1       2022-07-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  fastmap                1.1.1       2023-02-24 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  fastmatch              1.1-4       2023-08-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  fgsea                  1.28.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  forcats              * 1.0.0       2023-01-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  foreach                1.5.2       2022-02-02 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  fs                     1.6.3       2023-07-20 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  furrr                  0.3.1       2022-08-15 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  future                 1.33.1      2023-12-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  generics               0.1.3       2022-07-05 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  GenomeInfoDb           1.38.5      2023-12-28 [1] Bioconductor 3.18 (R 4.3.2)</span></span>
<span><span class="co">#&gt;  GenomeInfoDbData       1.2.11      2024-01-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  GenomicRanges          1.54.1      2023-10-29 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  GetoptLong             1.0.5       2020-12-15 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggforce                0.4.1       2022-10-04 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggfun                  0.1.4       2024-01-19 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggplot2              * 3.4.4       2023-10-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggplotify              0.1.2       2023-08-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggpubr                 0.6.0       2023-02-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggraph                 2.1.0       2022-10-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggrepel                0.9.5       2024-01-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggsignif               0.6.4       2022-10-13 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggtree                 3.10.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  GlobalOptions          0.1.2       2020-06-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  globals                0.16.2      2022-11-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  glue                   1.7.0       2024-01-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  GO.db                  3.18.0      2024-02-06 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  golem                  0.4.1       2023-06-05 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  GOSemSim               2.28.1      2024-01-17 [1] Bioconductor 3.18 (R 4.3.2)</span></span>
<span><span class="co">#&gt;  graph                  1.80.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  graphlayouts           1.1.0       2024-01-19 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  gridExtra              2.3         2017-09-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  gridGraphics           0.5-1       2020-12-13 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  GSEABase               1.64.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  gson                   0.1.0       2023-03-07 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  GSVA                 * 1.50.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  gtable                 0.3.4       2023-08-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  HDF5Array              1.30.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  HDO.db                 0.99.1      2024-02-06 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  highr                  0.10        2022-12-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  hms                    1.1.3       2023-03-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  htmltools              0.5.7       2023-11-03 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  htmlwidgets            1.6.4       2023-12-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  httpuv                 1.6.14      2024-01-26 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  httr                   1.4.7       2023-08-15 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  igraph                 2.0.1.1     2024-01-30 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  impute                 1.76.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  IRanges                2.36.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  irlba                  2.3.5.1     2022-10-03 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  iterators              1.0.14      2022-02-05 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  jquerylib              0.1.4       2021-04-26 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  jsonlite               1.8.8       2023-12-04 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  KEGGREST               1.42.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  knitr                  1.45        2023-10-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  labeling               0.4.3       2023-08-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  later                  1.3.2       2023-12-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  lattice                0.21-8      2023-04-05 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  lazyeval               0.2.2       2019-03-15 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  lifecycle              1.0.4       2023-11-07 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  limma                  3.58.1      2023-10-31 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  listenv                0.9.1       2024-01-29 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  lubridate            * 1.9.3       2023-09-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  magrittr             * 2.0.3       2022-03-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  MALDIquant             1.22.2      2024-01-22 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  MASS                   7.3-60      2023-05-04 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  massdatabase         * 1.0.10      2024-02-06 [1] Github (tidymass/massdatabase@211399a)</span></span>
<span><span class="co">#&gt;  massdataset          * 1.0.29      2024-02-06 [1] gitlab (tidymass/massdataset@90e65be)</span></span>
<span><span class="co">#&gt;  masstools            * 1.0.13      2024-02-06 [1] gitlab (tidymass/masstools@95a6b2b)</span></span>
<span><span class="co">#&gt;  Matrix                 1.6-5       2024-01-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  MatrixGenerics         1.14.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  matrixStats            1.2.0       2023-12-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  memoise                2.0.1       2021-11-26 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  metid                * 1.2.30      2024-02-06 [1] gitlab (tidymass/metid@659b771)</span></span>
<span><span class="co">#&gt;  metpath              * 1.0.8       2024-02-06 [1] gitlab (tidymass/metpath@62ac694)</span></span>
<span><span class="co">#&gt;  MicrobiomeProfiler   * 1.8.0       2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  mime                   0.12        2021-09-28 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  miniUI                 0.1.1.1     2018-05-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  MsCoreUtils            1.14.1      2023-11-03 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  MSnbase              * 2.28.1      2023-11-06 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  munsell                0.5.0       2018-06-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  mzID                   1.40.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  mzR                  * 2.36.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  ncdf4                  1.22        2023-11-28 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  nlme                   3.1-162     2023-01-31 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  openxlsx               4.2.5.2     2023-02-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  parallelly             1.36.0      2023-05-26 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  patchwork              1.2.0       2024-01-08 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pbapply                1.7-2       2023-06-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pcaMethods             1.94.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  pheatmap               1.0.12      2019-01-04 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pillar                 1.9.0       2023-03-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pkgbuild               1.4.3       2023-12-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pkgconfig              2.0.3       2019-09-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pkgload                1.3.4       2024-01-16 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  plotly                 4.10.4      2024-01-13 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  plyr                   1.8.9       2023-10-02 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  png                    0.1-8       2022-11-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  polyclip               1.10-6      2023-09-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  preprocessCore         1.64.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  prettyunits            1.2.0       2023-09-24 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  profvis                0.3.8       2023-05-02 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  progress               1.2.3       2023-12-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  promises               1.2.1       2023-08-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ProtGenerics         * 1.34.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  purrr                * 1.0.2       2023-08-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  qvalue                 2.34.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  R6                     2.5.1       2021-08-19 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  RColorBrewer           1.1-3       2022-04-03 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  Rcpp                 * 1.0.12      2024-01-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  RCurl                  1.98-1.14   2024-01-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  Rdisop                 1.62.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  readr                * 2.1.5       2024-01-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  readxl                 1.4.3       2023-07-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  remotes                2.4.2.1     2023-07-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  reshape2               1.4.4       2020-04-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rhdf5                  2.46.1      2023-11-29 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  rhdf5filters           1.14.1      2023-11-06 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  Rhdf5lib               1.24.1      2023-12-12 [1] Bioconductor 3.18 (R 4.3.2)</span></span>
<span><span class="co">#&gt;  rjson                  0.2.21      2022-01-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rlang                  1.1.3       2024-01-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rmarkdown              2.25        2023-09-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  RSQLite                2.3.5       2024-01-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rstatix                0.7.2       2023-02-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rstudioapi             0.15.0      2023-07-07 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rsvd                   1.0.5       2021-04-16 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rvest                  1.0.3       2022-08-19 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  S4Arrays               1.2.0       2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  S4Vectors            * 0.40.2      2023-11-23 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  sass                   0.4.8       2023-12-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ScaledMatrix           1.10.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  scales                 1.3.0       2023-11-28 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  scatterpie             0.2.1       2023-06-07 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  sessioninfo            1.2.2       2021-12-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  shadowtext             0.1.3       2024-01-19 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  shape                  1.4.6       2021-05-19 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  shiny                  1.8.0       2023-11-17 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  shinycustomloader      0.9.0       2018-03-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  shinyWidgets           0.8.1       2024-01-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  SingleCellExperiment   1.24.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  SparseArray            1.2.3       2023-12-25 [1] Bioconductor 3.18 (R 4.3.2)</span></span>
<span><span class="co">#&gt;  sparseMatrixStats      1.14.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  statmod                1.5.0       2023-01-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  stringdist             0.9.12      2023-11-28 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  stringi                1.8.3       2023-12-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  stringr              * 1.5.1       2023-11-14 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  SummarizedExperiment   1.32.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  tibble               * 3.2.1       2023-03-20 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  tidygraph              1.3.0       2023-12-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  tidyr                * 1.3.1       2024-01-24 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  tidyselect             1.2.0       2022-10-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  tidytree               0.4.6       2023-12-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  tidyverse            * 2.0.0       2023-02-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  timechange             0.3.0       2024-01-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  treeio                 1.26.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  tweenr                 2.0.2       2022-09-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  tzdb                   0.4.0       2023-05-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  urlchecker             1.0.1       2021-11-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  usethis                2.2.2       2023-07-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  utf8                   1.2.4       2023-10-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  vctrs                  0.6.5       2023-12-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  viridis                0.6.5       2024-01-29 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  viridisLite            0.4.2       2023-05-02 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  vsn                    3.70.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  withr                  3.0.0       2024-01-16 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  xfun                   0.41        2023-11-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  XML                    3.99-0.16.1 2024-01-22 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  xml2                   1.3.6       2023-12-04 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  xtable                 1.8-4       2019-04-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  XVector                0.42.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  yaml                   2.3.8       2023-12-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  yulab.utils            0.1.4       2024-01-28 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  zip                    2.3.0       2023-04-17 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  zlibbioc               1.48.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  [1] /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/library</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ──────────────────────────────────────────────────────────</span></span></code></pre></div>
</div>
<div id="reference-10" class="section level2" number="12.11">
<h2>
<span class="header-section-number">12.11</span> Reference<a class="anchor" aria-label="anchor" href="#reference-10"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p><a href="https://github.com/tidymass/massdatabase/">massdatabase github</a></p></li>
<li><p><a href="https://yulab-smu.top/biomedical-knowledge-mining-book/universal-api.html">Univeral enrichment analysis</a></p></li>
<li><p><a href="https://alexslemonade.github.io/refinebio-examples/03-rnaseq/pathway-analysis_rnaseq_03_gsva.html#1_Purpose_of_this_analysis">Gene set variation analysis - RNA-seq</a></p></li>
</ul>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="DifferetialAnalysis.html"><span class="header-section-number">11</span> Differetial Analysis</a></div>
<div class="next"><a href="MetOriginAnalysis.html"><span class="header-section-number">13</span> MetOrigin Analysis</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#FunctionalAnalysis"><span class="header-section-number">12</span> Functional Analysis</a></li>
<li><a class="nav-link" href="#%E5%8A%A0%E8%BD%BDr%E5%8C%85-8"><span class="header-section-number">12.1</span> 加载R包</a></li>
<li><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE-6"><span class="header-section-number">12.2</span> 导入数据</a></li>
<li><a class="nav-link" href="#%E8%8E%B7%E5%8F%96kegg-pathway%E5%92%8C%E4%BB%A3%E8%B0%A2%E7%89%A9id%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="header-section-number">12.3</span> 获取KEGG pathway和代谢物ID对应关系</a></li>
<li><a class="nav-link" href="#%E5%B7%AE%E5%BC%82%E4%BB%A3%E8%B0%A2%E7%89%A9%E7%AD%9B%E9%80%89"><span class="header-section-number">12.4</span> 差异代谢物筛选</a></li>
<li><a class="nav-link" href="#%E5%AF%8C%E9%9B%86%E5%88%86%E6%9E%90"><span class="header-section-number">12.5</span> 富集分析</a></li>
<li><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E9%80%9A%E8%B7%AF"><span class="header-section-number">12.6</span> 可视化通路</a></li>
<li><a class="nav-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="header-section-number">12.7</span> 案例</a></li>
<li><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="header-section-number">12.8</span> 问题</a></li>
<li>
<a class="nav-link" href="#ssgsea-single-sample-gene-set-enrichment-analysis"><span class="header-section-number">12.9</span> ssGSEA: Single sample gene set enrichment analysis</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E5%8A%A0%E8%BD%BDr%E5%8C%85-9"><span class="header-section-number">12.9.1</span> 加载R包</a></li>
<li><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE-7"><span class="header-section-number">12.9.2</span> 导入数据</a></li>
<li><a class="nav-link" href="#%E5%87%86%E5%A4%87%E4%BB%A3%E8%B0%A2%E7%BB%84%E6%96%87%E4%BB%B6"><span class="header-section-number">12.9.3</span> 准备代谢组文件</a></li>
<li><a class="nav-link" href="#%E5%87%86%E5%A4%87kegg%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="header-section-number">12.9.4</span> 准备KEGG配置文件</a></li>
<li><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E5%8D%95%E4%B8%AA%E6%A0%B7%E6%9C%AC%E7%9A%84gsea"><span class="header-section-number">12.9.5</span> 计算单个样本的GSEA</a></li>
<li><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E7%BB%93%E6%9E%9C-1"><span class="header-section-number">12.9.6</span> 可视化结果</a></li>
<li><a class="nav-link" href="#%E7%AE%B1%E7%BA%BF%E5%9B%BE%E5%B1%95%E7%A4%BA%E7%BB%93%E6%9E%9C"><span class="header-section-number">12.9.7</span> 箱线图展示结果</a></li>
</ul>
</li>
<li><a class="nav-link" href="#session-info-4"><span class="header-section-number">12.10</span> Session info</a></li>
<li><a class="nav-link" href="#reference-10"><span class="header-section-number">12.11</span> Reference</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/HuaZou/DraftNotes/blob/main/23-Metabolome-FunctionAnalysis.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/HuaZou/DraftNotes/edit/main/23-Metabolome-FunctionAnalysis.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>生物信息随记</strong>" was written by Hua Zou. It was last built on 2023-08-24 and updated on 2024-02-06.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
