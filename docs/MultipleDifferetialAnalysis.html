<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 15 Multiple Differetial Analysis | 生物信息随记</title>
<meta name="author" content="Hua Zou">
<meta name="description" content="识别组间差异物种是微生物领域常见的数据分析。我们采用三类不同的差异分析方法来发现显著差异的微生物物种，它们分别是： Linear Discriminant Analysis of Effect Size (LefSe). Microbiome Multivariable Association with Linear Models (Maaslin2). Analysis of...">
<meta name="generator" content="bookdown 0.37 with bs4_book()">
<meta property="og:title" content="Chapter 15 Multiple Differetial Analysis | 生物信息随记">
<meta property="og:type" content="book">
<meta property="og:url" content="https://zouhua.top/DraftNotes/MultipleDifferetialAnalysis.html">
<meta property="og:description" content="识别组间差异物种是微生物领域常见的数据分析。我们采用三类不同的差异分析方法来发现显著差异的微生物物种，它们分别是： Linear Discriminant Analysis of Effect Size (LefSe). Microbiome Multivariable Association with Linear Models (Maaslin2). Analysis of...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 15 Multiple Differetial Analysis | 生物信息随记">
<meta name="twitter:description" content="识别组间差异物种是微生物领域常见的数据分析。我们采用三类不同的差异分析方法来发现显著差异的微生物物种，它们分别是： Linear Discriminant Analysis of Effect Size (LefSe). Microbiome Multivariable Association with Linear Models (Maaslin2). Analysis of...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/Poppins-0.4.8/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.6.1/transition.js"></script><script src="libs/bs3compat-0.6.1/tabs.js"></script><script src="libs/bs3compat-0.6.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.31/datatables.js"></script><link href="libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.1/js/crosstalk.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="assets/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">生物信息随记</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> 介绍</a></li>
<li class="book-part">Data Set</li>
<li><a class="" href="ZeybelDataset.html"><span class="header-section-number">2</span> Zeybel Dataset</a></li>
<li class="book-part">Statistical Methods</li>
<li><a class="" href="GEEandMLM.html"><span class="header-section-number">3</span> GEE and MLM</a></li>
<li><a class="" href="HypothesisTestingMethods.html"><span class="header-section-number">4</span> Hypothesis Testing Methods</a></li>
<li><a class="" href="BatchEffectCorrection.html"><span class="header-section-number">5</span> Batch Effect Correction</a></li>
<li><a class="" href="LinearModelonMicrobialCommunity.html"><span class="header-section-number">6</span> Linear Model on Microbial Community</a></li>
<li><a class="" href="PermutationTest.html"><span class="header-section-number">7</span> Permutation Test</a></li>
<li><a class="" href="SurvivalAnalysis.html"><span class="header-section-number">8</span> Survival Analysis</a></li>
<li class="book-part">Metabolomics Data Analysis</li>
<li><a class="" href="dataprocessing.html"><span class="header-section-number">9</span> Data Processing</a></li>
<li><a class="" href="DimensionReduction.html"><span class="header-section-number">10</span> Dimension Reduction</a></li>
<li><a class="" href="DifferetialAnalysis.html"><span class="header-section-number">11</span> Differetial Analysis</a></li>
<li><a class="" href="FunctionalAnalysis.html"><span class="header-section-number">12</span> Functional Analysis</a></li>
<li><a class="" href="MetOriginAnalysis.html"><span class="header-section-number">13</span> MetOrigin Analysis</a></li>
<li><a class="" href="OtherAnalysis.html"><span class="header-section-number">14</span> Other Analysis</a></li>
<li class="book-part">Metagenomics Data Analysis</li>
<li><a class="active" href="MultipleDifferetialAnalysis.html"><span class="header-section-number">15</span> Multiple Differetial Analysis</a></li>
<li class="book-part">Machine Learning</li>
<li><a class="" href="randomforestalgorithm.html"><span class="header-section-number">16</span> Random Forest Algorithm</a></li>
<li><a class="" href="XGBoostalgorithm.html"><span class="header-section-number">17</span> XGBoost Algorithm</a></li>
<li class="book-part">Knowledge</li>
<li><a class="" href="Metageomics.html"><span class="header-section-number">18</span> Metageomics</a></li>
<li><a class="" href="Notes.html"><span class="header-section-number">19</span> Notes</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/HuaZou/DraftNotes">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="MultipleDifferetialAnalysis" class="section level1" number="15">
<h1>
<span class="header-section-number">15</span> Multiple Differetial Analysis<a class="anchor" aria-label="anchor" href="#MultipleDifferetialAnalysis"><i class="fas fa-link"></i></a>
</h1>
<p>识别组间差异物种是微生物领域常见的数据分析。我们采用三类不同的差异分析方法来发现显著差异的微生物物种，它们分别是：</p>
<ul>
<li><p>Linear Discriminant Analysis of Effect Size (LefSe).</p></li>
<li><p>Microbiome Multivariable Association with Linear Models (Maaslin2).</p></li>
<li><p>Analysis of Composition of Microbiomes with Bias Correction (ANCOM-BC).</p></li>
</ul>
<p><strong>LefSe</strong>是一种基于有监督的线性判别筛选差异物种的方法；<strong>Maaslin2</strong>是一种基于线性回归算法鉴定差异物种的方法；<strong>ANCOM-BC</strong>是一种校正样本之间绝对丰度偏差和零值膨胀等后再发现差异物种的方法。</p>
<p>我们将以<strong>LefSe</strong>识别出的差异物种作为基准，合并另外两种方法的差异结果，最后以柱状图展示结果。</p>
<div id="安装microbiomeanalysis包-1" class="section level2" number="15.1">
<h2>
<span class="header-section-number">15.1</span> 安装MicrobiomeAnalysis包<a class="anchor" aria-label="anchor" href="#%E5%AE%89%E8%A3%85microbiomeanalysis%E5%8C%85-1"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>MicrobiomeAnalysis可提供下面分析使用的函数</li>
</ul>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"remotes"</span>, <span class="st">"devtools"</span><span class="op">)</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"devtools"</span>, <span class="st">"remotes"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"HuaZou/MicrobiomeAnalysis"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="加载r包-12" class="section level2" number="15.2">
<h2>
<span class="header-section-number">15.2</span> 加载R包<a class="anchor" aria-label="anchor" href="#%E5%8A%A0%E8%BD%BDr%E5%8C%85-12"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb206"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>message <span class="op">=</span> <span class="cn">FALSE</span>, warning <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HuaZou/MicrobiomeAnalysis">MicrobiomeAnalysis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://huttenhower.sph.harvard.edu/maaslin2">Maaslin2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/FrederickHuangLin/ANCOMBC">ANCOMBC</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://dx.plos.org/10.1371/journal.pone.0061217">phyloseq</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/">ggpubr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># rm(list = ls())</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>stringsAsFactors <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>future.globals.maxSize <span class="op">=</span> <span class="fl">1000</span> <span class="op">*</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># group &amp; color</span></span>
<span><span class="va">sex_grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span></span>
<span><span class="va">sex_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#F28880"</span>, <span class="st">"#60C4D3"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lf_grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span>, <span class="st">"Moderate"</span>, <span class="st">"Severe"</span><span class="op">)</span></span>
<span><span class="va">lf_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#803C08"</span>, <span class="st">"#F1A340"</span>, <span class="st">"#2C0a4B"</span>, <span class="st">"#998EC3"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="导入数据-10" class="section level2" number="15.3">
<h2>
<span class="header-section-number">15.3</span> 导入数据<a class="anchor" aria-label="anchor" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE-10"><i class="fas fa-link"></i></a>
</h2>
<p>数据来自于Zeybel_2022的肠道微生物数据，可以在<strong>Zeybel Dataset</strong>章节的输出结果获取。</p>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"InputData/result/Zeybel_2022_gut_MGS_ps.RDS"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">phy</span></span>
<span><span class="co">#&gt; phyloseq-class experiment-level object</span></span>
<span><span class="co">#&gt; otu_table()   OTU Table:         [ 547 taxa and 42 samples ]</span></span>
<span><span class="co">#&gt; sample_data() Sample Data:       [ 42 samples by 46 sample variables ]</span></span>
<span><span class="co">#&gt; tax_table()   Taxonomy Table:    [ 547 taxa by 7 taxonomic ranks ]</span></span></code></pre></div>
<ul>
<li>因为没有绝对丰度表，暂时对相对丰度表进行转换成绝对丰度表（注意：需要提供准确的相对丰度表格，扩增子可用counts，Metaphlan系列可用FPKM等counts）</li>
</ul>
<div class="sourceCode" id="cb208"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phy_count</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/transformcounts.html">transform_sample_counts</a></span><span class="op">(</span></span>
<span>  <span class="va">phy</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">*</span><span class="fl">10</span><span class="op">^</span><span class="fl">7</span>, <span class="fl">0</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># head(otu_table(phy_count), 4)</span></span></code></pre></div>
</div>
<div id="linear-discriminant-analysis-of-effect-size-lefse" class="section level2" number="15.4">
<h2>
<span class="header-section-number">15.4</span> Linear Discriminant Analysis of Effect Size (LefSe)<a class="anchor" aria-label="anchor" href="#linear-discriminant-analysis-of-effect-size-lefse"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>计算函数</li>
</ul>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_lefse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">ps</span>,</span>
<span>  <span class="va">taxa_level</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="st">"Phylum"</span>, <span class="st">"Class"</span>, <span class="st">"Order"</span>, </span>
<span>                 <span class="st">"Family"</span>, <span class="st">"Genus"</span>, <span class="st">"Species"</span><span class="op">)</span>,</span>
<span>  <span class="va">filterCol</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">filterVars</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">group</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LiverFatClass"</span>, <span class="st">"Gender"</span><span class="op">)</span>,</span>
<span>  <span class="va">group_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span>, <span class="st">"Moderate"</span>, <span class="st">"Severe"</span>,</span>
<span>                  <span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span>,</span>
<span>  <span class="va">prev_cutoff</span> <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  <span class="va">mean_threshold</span> <span class="op">=</span> <span class="fl">0.0001</span>,</span>
<span>  <span class="va">one_threshold</span> <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>  <span class="va">LDA_cutoff</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># ps = phy</span></span>
<span>  <span class="co"># taxa_level = NULL</span></span>
<span>  <span class="co"># filterCol = NULL</span></span>
<span>  <span class="co"># filterVars = NULL</span></span>
<span>  <span class="co"># group = "LiverFatClass"</span></span>
<span>  <span class="co"># group_names = c("None", "Mild")</span></span>
<span>  <span class="co"># prev_cutoff = 0.1</span></span>
<span>  <span class="co"># mean_threshold = 0.0001</span></span>
<span>  <span class="co"># one_threshold = 0.001</span></span>
<span>  <span class="co"># LDA_cutoff = 0</span></span>
<span>  </span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">taxa_level</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ps_taxa</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/aggregate_taxa.html">aggregate_taxa</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">ps</span>, level <span class="op">=</span> <span class="va">taxa_level</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">ps_taxa</span> <span class="op">&lt;-</span> <span class="va">ps</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">metadata</span> <span class="op">&lt;-</span> <span class="va">ps_taxa</span><span class="op">@</span><span class="va">sam_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">filterCol</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dat_cln</span> <span class="op">&lt;-</span> <span class="va">metadata</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span> <span class="op">==</span> <span class="va">filterCol</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"FiltCol"</span></span>
<span>    <span class="va">dat_cln</span> <span class="op">&lt;-</span> <span class="va">metadata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">FiltCol</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">filterVars</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span> <span class="op">==</span> <span class="st">"FiltCol"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">filterCol</span>   </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># group for test </span></span>
<span>  <span class="va">dat_cln2</span> <span class="op">&lt;-</span> <span class="va">dat_cln</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln2</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln2</span><span class="op">)</span> <span class="op">==</span> <span class="va">group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Group_new"</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="st">"all"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dat_cln3</span> <span class="op">&lt;-</span> <span class="va">dat_cln2</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">dat_cln3</span> <span class="op">&lt;-</span> <span class="va">dat_cln2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Group_new</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">dat_cln3</span><span class="op">$</span><span class="va">Group_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">$</span><span class="va">Group_new</span>, levels <span class="op">=</span> <span class="va">group_names</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Group_new"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group</span></span>
<span>  </span>
<span>  <span class="va">ps_temp</span> <span class="op">&lt;-</span> <span class="va">ps_taxa</span></span>
<span>  <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps_temp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">)</span>  </span>
<span>  </span>
<span>  <span class="co"># trim &amp; filter</span></span>
<span>  <span class="va">ps_trim</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/trim_prevalence.html">trim_prevalence</a></span><span class="op">(</span></span>
<span>    object <span class="op">=</span> <span class="va">ps_temp</span>,</span>
<span>    cutoff <span class="op">=</span> <span class="va">prev_cutoff</span>,</span>
<span>    trim <span class="op">=</span> <span class="st">"feature"</span><span class="op">)</span></span>
<span>  <span class="va">ps_filter</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/filter_abundance.html">filter_abundance</a></span><span class="op">(</span></span>
<span>    object <span class="op">=</span> <span class="va">ps_trim</span>,</span>
<span>    cutoff_mean <span class="op">=</span> <span class="va">mean_threshold</span>,</span>
<span>    cutoff_one <span class="op">=</span> <span class="va">one_threshold</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># run lefse</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  <span class="va">res_lefse</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/run_lefse.html">run_lefse</a></span><span class="op">(</span></span>
<span>                    ps <span class="op">=</span> <span class="va">ps_filter</span>,</span>
<span>                    group <span class="op">=</span> <span class="va">group</span>,</span>
<span>                    taxa_rank <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>                    norm <span class="op">=</span> <span class="st">"CPM"</span>,</span>
<span>                    lda_cutoff <span class="op">=</span> <span class="va">LDA_cutoff</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="va">res_lda</span> <span class="op">&lt;-</span> <span class="va">res_lefse</span><span class="op">@</span><span class="va">marker_table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">ps_filter</span><span class="op">@</span><span class="va">tax_table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                        <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="st">"feature"</span><span class="op">)</span>,</span>
<span>                      by <span class="op">=</span> <span class="st">"feature"</span><span class="op">)</span></span>
<span>  <span class="co"># Number of Group</span></span>
<span>  <span class="va">input_metadata</span> <span class="op">&lt;-</span> <span class="va">ps_filter</span><span class="op">@</span><span class="va">sam_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">)</span> <span class="op">==</span> <span class="va">group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Compvar"</span></span>
<span>  <span class="va">dat_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">$</span><span class="va">Compvar</span><span class="op">)</span></span>
<span>  <span class="va">dat_status_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">dat_status</span><span class="op">)</span></span>
<span>  <span class="va">dat_status_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dat_status</span><span class="op">)</span></span>
<span>  <span class="va">res_lda</span><span class="op">$</span><span class="va">Block</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">dat_status_number</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">dat_status_name</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>,</span>
<span>                       <span class="st">"vs"</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">dat_status_number</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">dat_status_name</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span>  </span>
<span>  <span class="va">res_DA</span> <span class="op">&lt;-</span> <span class="va">res_lda</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>TaxaID <span class="op">=</span> <span class="va">feature</span>,</span>
<span>                  Enrichment <span class="op">=</span> <span class="va">enrich_group</span>,</span>
<span>                  LDA_Score <span class="op">=</span> <span class="va">ef_lda</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>LDA_Score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Enrichment</span> <span class="op">==</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                                     <span class="op">-</span><span class="va">LDA_Score</span>, <span class="va">LDA_Score</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">TaxaID</span>, <span class="va">Block</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># final results list</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="va">ps_filter</span>,</span>
<span>              test_res <span class="op">=</span> <span class="va">res_DA</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">get_lefse_pl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">dat</span>,</span>
<span>  <span class="va">index</span>,</span>
<span>  <span class="va">cutoff</span> <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  <span class="va">group_color</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># dat = res_DA</span></span>
<span>  <span class="co"># index = "LDA_Score"</span></span>
<span>  <span class="co"># cutoff = 2</span></span>
<span>  <span class="co"># group_color = lf_col[c(1, 4)]  </span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">plot_lefse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">da_res</span>,</span>
<span>    <span class="va">group_names</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    <span class="va">x_index</span>,</span>
<span>    <span class="va">x_index_cutoff</span> <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    <span class="va">group_color</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"red"</span><span class="op">)</span>,</span>
<span>    <span class="va">line_size</span> <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>    <span class="va">theme_text_size</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    <span class="va">theme_title_size</span> <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    <span class="va">theme_legend_size</span> <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>    <span class="co"># group</span></span>
<span>    <span class="va">da_res_group_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\d+_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">da_res</span><span class="op">$</span><span class="va">Block</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" vs "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">group_names</span> <span class="op">&lt;-</span> <span class="va">da_res_group_names</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">group_names</span> <span class="op">==</span> <span class="va">da_res_group_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"group names are in wrong order, and reoder them"</span><span class="op">)</span></span>
<span>        <span class="va">group_names</span> <span class="op">&lt;-</span> <span class="va">da_res_group_names</span></span>
<span>      <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>        <span class="va">group_names</span> <span class="op">&lt;-</span> <span class="va">group_names</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">x_index</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">da_res</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"No x_index matched the DA results' column, please check out your inputdata"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">da_res</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">da_res</span><span class="op">)</span> <span class="op">==</span> <span class="va">x_index</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Xindex"</span></span>
<span>    <span class="co"># significant results</span></span>
<span>  </span>
<span>    <span class="co"># enrichment by new LDA cutoff</span></span>
<span>    <span class="va">da_res</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">da_res</span><span class="op">$</span><span class="va">Xindex</span> <span class="op">&gt;</span> <span class="va">x_index_cutoff</span><span class="op">)</span>, <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="va">da_res</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">da_res</span><span class="op">$</span><span class="va">Xindex</span> <span class="op">&lt;</span> <span class="op">-</span><span class="va">x_index_cutoff</span><span class="op">)</span>, <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">da_res</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">da_res</span><span class="op">$</span><span class="va">Xindex</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">x_index_cutoff</span><span class="op">)</span>, <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Nonsignif"</span></span>
<span>    <span class="va">df_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">da_res</span><span class="op">$</span><span class="va">EnrichedDir</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Group"</span>, <span class="st">"Number"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">grp1_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">grp2_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">nsf_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"Nonsignif"</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">legend_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" ("</span>, <span class="va">grp1_number</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Nonsignif"</span>, <span class="st">" ("</span>, <span class="va">nsf_number</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">" ("</span>, <span class="va">grp2_number</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="va">da_res_signif</span> <span class="op">&lt;-</span> <span class="va">da_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">Xindex</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">Xindex</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">x_index_cutoff</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">da_res_signif</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"There is no significant taxa matched the threshold of LDA_Score"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">group_color</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">plot_group_color</span> <span class="op">&lt;-</span> <span class="va">group_color</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">plot_group_color</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">group_names</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="va">plot_group_color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green"</span>, <span class="st">"red"</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">plot_group_color</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">group_names</span></span>
<span>    <span class="op">}</span></span>
<span>  </span>
<span>    <span class="va">dat_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">da_res_signif</span><span class="op">$</span><span class="va">Xindex</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">dat_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">x_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">dat_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">da_res_signif</span><span class="op">$</span><span class="va">Xindex</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">dat_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">dat_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">dat_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="va">x_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dat_start</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">dat_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">da_res_signif</span><span class="op">$</span><span class="va">Xindex</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">dat_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="va">dat_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">dat_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">dat_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="va">x_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dat_start</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">dat_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">limits</span> <span class="op">&lt;-</span> <span class="va">x_range</span></span>
<span>    <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>    <span class="va">break_scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">da_res_signif</span><span class="op">$</span><span class="va">Xindex</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">6</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">break_scale</span> <span class="op">&gt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">break_scale_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">break_scale</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">break_scale_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">break_scale</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">x_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">x_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">break_scale_final</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">da_res_signif</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">TaxaID</span>, <span class="va">Xindex</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">Xindex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Enrichment</span><span class="op">)</span>,</span>
<span>               color <span class="op">=</span> <span class="st">"black"</span>, width <span class="op">=</span> <span class="fl">.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, alpha <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="va">line_size</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">breaks</span><span class="op">[</span><span class="va">breaks</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="fl">2</span>, size <span class="op">=</span> <span class="va">line_size</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">plot_group_color</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">breaks</span>, limits <span class="op">=</span> <span class="va">limits</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="va">x_index</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.ticks.length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>            axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>            axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>            axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">theme_title_size</span>, color <span class="op">=</span> <span class="st">"black"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>            axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">theme_text_size</span>, color <span class="op">=</span> <span class="st">"black"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>            axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">theme_text_size</span>, color <span class="op">=</span> <span class="st">"black"</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>,</span>
<span>            legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">theme_legend_size</span>, face <span class="op">=</span> <span class="st">"bold"</span>, color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>                                     margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>r <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.76</span>, <span class="fl">.05</span><span class="op">)</span>,</span>
<span>            legend.direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>            legend.key.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>            legend.key.height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>  </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pl</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu">plot_lefse</span><span class="op">(</span></span>
<span>    da_res <span class="op">=</span> <span class="va">dat</span>,</span>
<span>    x_index <span class="op">=</span> <span class="va">index</span>,</span>
<span>    x_index_cutoff <span class="op">=</span> <span class="va">cutoff</span>,</span>
<span>    group_color <span class="op">=</span> <span class="va">group_color</span>,</span>
<span>    theme_legend_size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pl</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># plot boxplot</span></span>
<span><span class="va">get_boxplot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">ps</span>,</span>
<span>  <span class="va">feature</span>,</span>
<span>  <span class="va">group</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LiverFatClass"</span>, <span class="st">"Gender"</span><span class="op">)</span>,</span>
<span>  <span class="va">group_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span>, <span class="st">"Moderate"</span>, <span class="st">"Severe"</span>,</span>
<span>                  <span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span>,</span>
<span>  <span class="va">group_color</span>,</span>
<span>  <span class="va">pl_title</span>,</span>
<span>  <span class="va">pos_cutoff</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.002</span><span class="op">)</span> <span class="op">{</span></span>
<span>                                  </span>
<span>  <span class="co"># ps = lefse_df$ps</span></span>
<span>  <span class="co"># feature = "s__Dorea_longicatena"</span></span>
<span>  <span class="co"># group = "LiverFatClass"</span></span>
<span>  <span class="co"># group_names = c("None", "Mild")</span></span>
<span>  <span class="co"># group_color = lf_col[c(1, 2)]</span></span>
<span>  <span class="co"># pl_title = "Dorea_longicatena"</span></span>
<span>  <span class="co"># pos_cutoff = -0.002</span></span>
<span>  </span>
<span>  <span class="co"># metadata</span></span>
<span>  <span class="va">dat_phe</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># group</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_phe</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_phe</span><span class="op">)</span> <span class="op">==</span> <span class="va">group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Group_new"</span></span>
<span>  <span class="va">phen</span> <span class="op">&lt;-</span> <span class="va">dat_phe</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Group_new</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Group_new</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="st">"TempRowNames"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># features</span></span>
<span>  <span class="va">prof</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/otu_table-methods.html">otu_table</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">feature</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="st">"TempRowNames"</span><span class="op">)</span>    </span>
<span>  </span>
<span>  <span class="va">plotdata</span> <span class="op">&lt;-</span> <span class="va">phen</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">prof</span>, by <span class="op">=</span> <span class="st">"TempRowNames"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Group_new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Group_new</span>, levels <span class="op">=</span> <span class="va">group_names</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">plotdata</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Group"</span>, <span class="st">"Index"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">occ_cutoff</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">occ_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">&gt;</span> <span class="va">occ_cutoff</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">plotOcc</span> <span class="op">&lt;-</span> <span class="va">plotdata</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Group</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="fu">occ_fun</span><span class="op">(</span><span class="va">Index</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>occ_lab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">occ</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="st">"%"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">plotdata</span><span class="op">$</span><span class="va">Index</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">plotdata</span><span class="op">$</span><span class="va">Index</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.1</span>,</span>
<span>                  position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">pos_cutoff</span>, <span class="va">position</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plotdata</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Group</span>, y <span class="op">=</span> <span class="va">Index</span>, color <span class="op">=</span> <span class="va">Group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">stat_boxplot</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"errorbar"</span>, width <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">.4</span>, outlier.shape <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, shape <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">"Relative Abundance"</span>, title <span class="op">=</span> <span class="va">pl_title</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html">expansion</a></span><span class="op">(</span>mult <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plotOcc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Group</span>, y <span class="op">=</span> <span class="va">position</span>, size <span class="op">=</span> <span class="va">occ</span><span class="op">)</span>, </span>
<span>               show.legend <span class="op">=</span> <span class="cn">FALSE</span>, shape <span class="op">=</span> <span class="fl">1</span>, stroke <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plotOcc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Group</span>, y <span class="op">=</span> <span class="va">position</span>, label <span class="op">=</span> <span class="va">occ_lab</span><span class="op">)</span>,</span>
<span>              show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html">scale_size_continuous</a></span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">13</span>, color <span class="op">=</span> <span class="st">"black"</span>, face <span class="op">=</span> <span class="st">"bold"</span>, hjust <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,</span>
<span>          axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, color <span class="op">=</span> <span class="st">"black"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>          text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">9</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span>  </span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pl</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<ul>
<li>lefse结果</li>
</ul>
<p>以LiverFatClass作为分组，选择None和Mild两个分组进行差异分析</p>
<div class="sourceCode" id="cb210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lefse_df</span> <span class="op">&lt;-</span> <span class="fu">get_lefse</span><span class="op">(</span></span>
<span>  ps <span class="op">=</span> <span class="va">phy</span>,</span>
<span>  taxa_level <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  filterCol <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  filterVars <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"LiverFatClass"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span><span class="op">)</span>,</span>
<span>  prev_cutoff <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  mean_threshold <span class="op">=</span> <span class="fl">0.0001</span>,</span>
<span>  one_threshold <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>  LDA_cutoff <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">lefse_df</span><span class="op">$</span><span class="va">test_res</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      TaxaID             Block Enrichment</span></span>
<span><span class="co">#&gt; 1  s__Prevotella_sp_CAG_520 9_None vs 12_Mild       None</span></span>
<span><span class="co">#&gt; 2 s__Prevotella_sp_CAG_5226 9_None vs 12_Mild       None</span></span>
<span><span class="co">#&gt; 3  s__Prevotella_sp_AM42_24 9_None vs 12_Mild       None</span></span></code></pre></div>
<p>结果：总计16种显著差异的species被lefse方法识别出来</p>
<ul>
<li>可视化结果</li>
</ul>
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lefse_pl</span> <span class="op">&lt;-</span> <span class="fu">get_lefse_pl</span><span class="op">(</span></span>
<span>  dat <span class="op">=</span> <span class="va">lefse_df</span><span class="op">$</span><span class="va">test_res</span>,</span>
<span>  index <span class="op">=</span> <span class="st">"LDA_Score"</span>,</span>
<span>  cutoff <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  group_color <span class="op">=</span> <span class="va">lf_col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lefse_pl</span></span></code></pre></div>
<div class="inline-figure"><img src="30-Metagenome_DifferentialAnalysis_files/figure-html/unnamed-chunk-7-1.png" width="100%"></div>
<p>结果：13类差异菌富集在None组，3类差异菌富集在Mild组</p>
<ul>
<li>箱线图展示特定菌</li>
</ul>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_boxplot</span><span class="op">(</span></span>
<span>  ps <span class="op">=</span> <span class="va">lefse_df</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>  feature <span class="op">=</span> <span class="st">"s__Dorea_longicatena"</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"LiverFatClass"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span><span class="op">)</span>,</span>
<span>  group_color <span class="op">=</span> <span class="va">lf_col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  pl_title <span class="op">=</span> <span class="st">"Dorea_longicatena"</span>,</span>
<span>  pos_cutoff <span class="op">=</span> <span class="op">-</span><span class="fl">0.002</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-Metagenome_DifferentialAnalysis_files/figure-html/unnamed-chunk-8-1.png" width="100%"></div>
<p>结果：<em>Dorea longicatena</em>在两组出现率均很高（大于90%），并且相对丰度在None组更高，但这种现象可能由于最右边的离群点导致的。</p>
</div>
<div id="microbiome-multivariable-association-with-linear-models-maaslin2" class="section level2" number="15.5">
<h2>
<span class="header-section-number">15.5</span> Microbiome Multivariable Association with Linear Models (Maaslin2)<a class="anchor" aria-label="anchor" href="#microbiome-multivariable-association-with-linear-models-maaslin2"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>计算函数</li>
</ul>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_Maaslin2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">ps</span>,</span>
<span>  <span class="va">taxa_level</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="st">"Phylum"</span>, <span class="st">"Class"</span>, <span class="st">"Order"</span>, </span>
<span>                 <span class="st">"Family"</span>, <span class="st">"Genus"</span>, <span class="st">"Species"</span>, <span class="st">"Strain"</span><span class="op">)</span>,</span>
<span>  <span class="va">filterCol</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">filterVars</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">group</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LiverFatClass"</span>, <span class="st">"Gender"</span><span class="op">)</span>,</span>
<span>  <span class="va">group_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span>, <span class="st">"Moderate"</span>, <span class="st">"Severe"</span>,</span>
<span>                  <span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span>,</span>
<span>  <span class="va">prev_cutoff</span> <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  <span class="va">mean_threshold</span> <span class="op">=</span> <span class="fl">0.0001</span>,</span>
<span>  <span class="va">one_threshold</span> <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>  <span class="va">fix_vars</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Age"</span>, <span class="st">"Gender"</span><span class="op">)</span>,</span>
<span>  <span class="va">outputname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># ps = phy</span></span>
<span>  <span class="co"># taxa_level = NULL</span></span>
<span>  <span class="co"># filterCol = NULL</span></span>
<span>  <span class="co"># filterVars = NULL</span></span>
<span>  <span class="co"># group = "LiverFatClass"</span></span>
<span>  <span class="co"># group_names = c("None", "Mild")</span></span>
<span>  <span class="co"># prev_cutoff = 0.1</span></span>
<span>  <span class="co"># mean_threshold = 0.0001</span></span>
<span>  <span class="co"># one_threshold = 0.001</span></span>
<span>  <span class="co"># fix_vars = c("Age", "Gender")</span></span>
<span>  <span class="co"># outputname = "LiverFatClass_NM"</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">taxa_level</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ps_taxa</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/aggregate_taxa.html">aggregate_taxa</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">ps</span>, level <span class="op">=</span> <span class="va">taxa_level</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">ps_taxa</span> <span class="op">&lt;-</span> <span class="va">ps</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">metadata</span> <span class="op">&lt;-</span> <span class="va">ps_taxa</span><span class="op">@</span><span class="va">sam_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">filterCol</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dat_cln</span> <span class="op">&lt;-</span> <span class="va">metadata</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span> <span class="op">==</span> <span class="va">filterCol</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"FiltCol"</span></span>
<span>    <span class="va">dat_cln</span> <span class="op">&lt;-</span> <span class="va">metadata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">FiltCol</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">filterVars</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span> <span class="op">==</span> <span class="st">"FiltCol"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">filterCol</span>   </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># group for test </span></span>
<span>  <span class="va">dat_cln2</span> <span class="op">&lt;-</span> <span class="va">dat_cln</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln2</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln2</span><span class="op">)</span> <span class="op">==</span> <span class="va">group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Group_new"</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="st">"all"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dat_cln3</span> <span class="op">&lt;-</span> <span class="va">dat_cln2</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">dat_cln3</span> <span class="op">&lt;-</span> <span class="va">dat_cln2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Group_new</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">dat_cln3</span><span class="op">$</span><span class="va">Group_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">$</span><span class="va">Group_new</span>, levels <span class="op">=</span> <span class="va">group_names</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Group_new"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group</span></span>
<span>  </span>
<span>  <span class="va">ps_temp</span> <span class="op">&lt;-</span> <span class="va">ps_taxa</span></span>
<span>  <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps_temp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">)</span>  </span>
<span>  </span>
<span>  <span class="co"># trim &amp; filter</span></span>
<span>  <span class="va">ps_trim</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/trim_prevalence.html">trim_prevalence</a></span><span class="op">(</span></span>
<span>    object <span class="op">=</span> <span class="va">ps_temp</span>,</span>
<span>    cutoff <span class="op">=</span> <span class="va">prev_cutoff</span>,</span>
<span>    trim <span class="op">=</span> <span class="st">"feature"</span><span class="op">)</span></span>
<span>  <span class="va">ps_filter</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/filter_abundance.html">filter_abundance</a></span><span class="op">(</span></span>
<span>    object <span class="op">=</span> <span class="va">ps_trim</span>,</span>
<span>    cutoff_mean <span class="op">=</span> <span class="va">mean_threshold</span>,</span>
<span>    cutoff_one <span class="op">=</span> <span class="va">one_threshold</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># maaslin2</span></span>
<span>  <span class="va">inputdata</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/otu_table-methods.html">otu_table</a></span><span class="op">(</span><span class="va">ps_filter</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">input_metadata</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps_filter</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> </span>
<span>  <span class="co">## output</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="st">"./InputData/result/Maaslin2"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="st">"./InputData/result/Maaslin2"</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"./InputData/result/Maaslin2/"</span>, <span class="va">outputname</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="va">output</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">#################################################################</span></span>
<span>  <span class="co"># how to set random or fixed effects: https://forum.biobakery.org/t/confounding-factors/154/3</span></span>
<span>  <span class="va">fix_factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">fix_vars</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># reference </span></span>
<span>  <span class="va">ref_value_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">group</span>, <span class="st">","</span> ,<span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">ref_value_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">g</span> <span class="kw">in</span> <span class="va">fix_vars</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">[</span>, <span class="va">g</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">temp_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">g</span>, <span class="st">","</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">[</span>, <span class="va">g</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">ref_value_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ref_value_factor</span>, <span class="va">temp_ref</span><span class="op">)</span>      </span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>  </span>
<span>  </span>
<span>  <span class="va">ref_value_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ref_value_group</span>, <span class="va">ref_value_factor</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">";"</span><span class="op">)</span></span>
<span>  <span class="co">#################################################################</span></span>
<span>  <span class="co"># Masslin2 (v.1.4.0) was run using Logit-transformed relative abundances </span></span>
<span>  <span class="co"># that were normalized with total-sum-scaling (TSS) and using the variable of interest as a fixed effect</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">Maaslin2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Maaslin2/man/Maaslin2.html">Maaslin2</a></span><span class="op">(</span></span>
<span>            input_data <span class="op">=</span> <span class="va">inputdata</span>,</span>
<span>            input_metadata <span class="op">=</span> <span class="va">input_metadata</span>,</span>
<span>            output <span class="op">=</span> <span class="va">output</span>,</span>
<span>            min_abundance <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>            min_prevalence <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>            min_variance <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>            normalization <span class="op">=</span> <span class="st">"TSS"</span>, <span class="co"># "NONE", "TSS", "CLR", "CSS", "TMM"</span></span>
<span>            transform <span class="op">=</span> <span class="st">"LOGIT"</span>, <span class="co"># "NONE", "LOG", "LOGIT", "AST"</span></span>
<span>            analysis_method <span class="op">=</span> <span class="st">"LM"</span>, <span class="co"># "LM", "CPLM", "NEGBIN", "ZINB"</span></span>
<span>            max_significance <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>            <span class="co"># random_effects = rand_var,</span></span>
<span>            fixed_effects <span class="op">=</span> <span class="va">fix_factors</span>,</span>
<span>            correction <span class="op">=</span> <span class="st">"BH"</span>,</span>
<span>            standardize <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>            cores <span class="op">=</span> <span class="fl">5</span>,</span>
<span>            plot_heatmap <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>            plot_scatter <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>            heatmap_first_n <span class="op">=</span> <span class="fl">50</span>,</span>
<span>            reference <span class="op">=</span> <span class="va">ref_value_final</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">res_temp</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Number of Group</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">)</span> <span class="op">==</span> <span class="va">group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Compvar"</span></span>
<span>  <span class="va">dat_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">$</span><span class="va">Compvar</span><span class="op">)</span></span>
<span>  <span class="va">dat_status_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">dat_status</span><span class="op">)</span></span>
<span>  <span class="va">dat_status_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dat_status</span><span class="op">)</span></span>
<span>  <span class="va">res_temp</span><span class="op">$</span><span class="va">Block</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">dat_status_number</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">dat_status_name</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>,</span>
<span>                       <span class="st">"vs"</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">dat_status_number</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">dat_status_name</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">res_test</span> <span class="op">&lt;-</span> <span class="va">res_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">feature</span>, <span class="va">Block</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">ps_filter</span><span class="op">@</span><span class="va">tax_table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                        <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="st">"feature"</span><span class="op">)</span>,</span>
<span>                      by <span class="op">=</span> <span class="st">"feature"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>TaxaID <span class="op">=</span> <span class="va">feature</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Enrichment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">coef</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">TaxaID</span>, <span class="va">Block</span>, <span class="va">metadata</span>, <span class="va">value</span>, <span class="va">Enrichment</span>, <span class="va">coef</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># final results list</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="va">ps_filter</span>,</span>
<span>              test_res <span class="op">=</span> <span class="va">res_test</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="va">get_Maaslin2_pl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">dat</span>,</span>
<span>    <span class="va">lg2fc_cutoff</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    <span class="va">pval_cutoff</span> <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    <span class="va">qval_cutoff</span> <span class="op">=</span> <span class="fl">0.8</span>, <span class="co">#0.05,</span></span>
<span>    <span class="va">group_color</span>,</span>
<span>    <span class="va">plot_title</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># dat = Maaslin2_df$test_res</span></span>
<span>  <span class="co"># lg2fc_cutoff = 0</span></span>
<span>  <span class="co"># pval_cutoff = 0.05</span></span>
<span>  <span class="co"># qval_cutoff = 0.8</span></span>
<span>  <span class="co"># group_color = lf_col[c(1, 2)]</span></span>
<span>  <span class="co"># plot_title = "None vs Mild"  </span></span>
<span>  </span>
<span>  <span class="co"># group_names</span></span>
<span>  <span class="va">group_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\d+_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Block</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" vs "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># convert coef into log2foldchange</span></span>
<span>  <span class="va">dat</span><span class="op">$</span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span></span>
<span>  <span class="va">dat</span><span class="op">$</span><span class="va">lg2fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log2</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">fc</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># enrichment by beta and Pvalue AdjustedPvalue</span></span>
<span>  <span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">lg2fc</span> <span class="op">&gt;</span> <span class="va">lg2fc_cutoff</span> <span class="op">&amp;</span> </span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span> <span class="op">&amp;</span> </span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">lg2fc</span> <span class="op">&lt;</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span> <span class="op">&amp;</span> </span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span> <span class="op">&amp;</span> </span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">lg2fc</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">lg2fc_cutoff</span> <span class="op">|</span> </span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">pval</span> <span class="op">&gt;=</span> <span class="va">pval_cutoff</span> <span class="op">|</span></span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">qval</span> <span class="op">&gt;=</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Nonsignif"</span></span>
<span>  </span>
<span>  <span class="va">dat</span><span class="op">$</span><span class="va">EnrichedDir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">EnrichedDir</span>,</span>
<span>                            levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"Nonsignif"</span>, <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># dat status </span></span>
<span>  <span class="va">df_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">EnrichedDir</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Group"</span>, <span class="st">"Number"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">grp1_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">grp2_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">nsf_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"Nonsignif"</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">legend_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" ("</span>, <span class="va">grp1_number</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Nonsignif"</span>, <span class="st">" ("</span>, <span class="va">nsf_number</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">" ("</span>, <span class="va">grp2_number</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># significant features</span></span>
<span>  <span class="va">dat_signif</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">lg2fc</span>, <span class="va">pval</span>, <span class="va">qval</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>    </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">lg2fc</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">lg2fc_cutoff</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># color </span></span>
<span>  <span class="va">plot_group_color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">group_color</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"grey"</span>, <span class="va">group_color</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">plot_group_color</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"Nonsignif"</span>, <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># labels</span></span>
<span>  <span class="va">xlabel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Log2FC[Maaslin2] ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">group_names</span>, collapse <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span></span>
<span>  <span class="va">ylable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="op">-</span><span class="va">log</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span><span class="op">(</span><span class="st">"Pvalue (AdjustedPvalue &lt; 0.8)"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lg2fc</span>, y <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">pval</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">EnrichedDir</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">1</span>, stroke <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       values <span class="op">=</span> <span class="va">plot_group_color</span>,</span>
<span>                       labels <span class="op">=</span> <span class="va">legend_label</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="va">xlabel</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="va">ylable</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">lg2fc_cutoff</span>, alpha <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="fl">2</span>, size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span>, alpha <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="fl">2</span>, size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>             x <span class="op">=</span> <span class="va">lg2fc_cutoff</span>, y <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             label <span class="op">=</span> <span class="va">lg2fc_cutoff</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">5</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span>, y <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             label <span class="op">=</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">5</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log1p"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">pval_cutoff</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="fl">2</span>, size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>             x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">lg2fc</span><span class="op">)</span>,</span>
<span>             y <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">pval_cutoff</span><span class="op">)</span>,</span>
<span>             label <span class="op">=</span> <span class="va">pval_cutoff</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">5</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html">geom_text_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat_signif</span>,</span>
<span>                             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">TaxaID</span><span class="op">)</span>,</span>
<span>                             size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                             max.overlaps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"ggrepel.max.overlaps"</span>, default <span class="op">=</span> <span class="fl">80</span><span class="op">)</span>,</span>
<span>                             segment.linetype <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                             segment.curvature <span class="op">=</span> <span class="op">-</span><span class="fl">1e-20</span>,</span>
<span>                             box.padding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.35</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>                             point.padding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>                             arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.005</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                             bg.r <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, face <span class="op">=</span> <span class="st">"bold"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>          axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">9</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>          text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>          legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.15</span>, <span class="fl">.1</span><span class="op">)</span>,</span>
<span>          legend.key.height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>          legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">9</span>, face <span class="op">=</span> <span class="st">"bold"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          legend.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="va">plot_title</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">12</span>, hjust <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pl</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<ul>
<li>Maaslin2结果</li>
</ul>
<p>以LiverFatClass作为分组，选择None和Mild两个分组进行差异分析</p>
<div class="sourceCode" id="cb214"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Maaslin2_df</span> <span class="op">&lt;-</span> <span class="fu">get_Maaslin2</span><span class="op">(</span></span>
<span>  ps <span class="op">=</span> <span class="va">phy</span>,</span>
<span>  taxa_level <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  filterCol <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  filterVars <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"LiverFatClass"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span><span class="op">)</span>,</span>
<span>  prev_cutoff <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  mean_threshold <span class="op">=</span> <span class="fl">0.0001</span>,</span>
<span>  one_threshold <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>  fix_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Age"</span>, <span class="st">"Gender"</span><span class="op">)</span>,</span>
<span>  outputname <span class="op">=</span> <span class="st">"LiverFatClass_NM"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Warning: Deleting existing log file: ./InputData/result/Maaslin2/LiverFatClass_NM/maaslin2.log"</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.85232 INFO::Writing function arguments to log file</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.866709 INFO::Verifying options selected are valid</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.905568 INFO::Determining format of input files</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.906125 INFO::Input format is data samples as rows and metadata samples as rows</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.908775 INFO::Formula for fixed effects: expr ~  LiverFatClass + Age + Gender</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.909789 INFO::Filter data based on min abundance and min prevalence</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.910164 INFO::Total samples in data: 21</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.910524 INFO::Min samples required with min abundance for a feature not to be filtered: 2.100000</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.912028 INFO::Total filtered features: 0</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.912498 INFO::Filtered feature names from abundance and prevalence filtering:</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.91579 INFO::Total filtered features with variance filtering: 0</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.916185 INFO::Filtered feature names from variance filtering:</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.916535 INFO::Running selected normalization method: TSS</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.919173 INFO::Bypass z-score application to metadata</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.919756 INFO::Running selected transform method: LOGIT</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.922996 INFO::Running selected analysis method: LM</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:11.924694 INFO::Creating cluster of 5 R processes</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:13.330128 INFO::Counting total values for each feature</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:13.346912 WARNING::Deleting existing residuals file: ./InputData/result/Maaslin2/LiverFatClass_NM/residuals.rds</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:13.348054 INFO::Writing residuals to file ./InputData/result/Maaslin2/LiverFatClass_NM/residuals.rds</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:13.349395 WARNING::Deleting existing fitted file: ./InputData/result/Maaslin2/LiverFatClass_NM/fitted.rds</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:13.350187 INFO::Writing fitted values to file ./InputData/result/Maaslin2/LiverFatClass_NM/fitted.rds</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:13.351336 INFO::Writing all results to file (ordered by increasing q-values): ./InputData/result/Maaslin2/LiverFatClass_NM/all_results.tsv</span></span>
<span><span class="co">#&gt; 2024-02-06 22:17:13.357204 INFO::Writing the significant results (those which are less than or equal to the threshold of 0.300000 ) to file (ordered by increasing q-values): ./InputData/result/Maaslin2/LiverFatClass_NM/significant_results.tsv</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">Maaslin2_df</span><span class="op">$</span><span class="va">test_res</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;                        TaxaID             Block</span></span>
<span><span class="co">#&gt; 1 s__Actinomyces_graevenitzii 9_None vs 12_Mild</span></span>
<span><span class="co">#&gt; 2   s__Alistipes_indistinctus 9_None vs 12_Mild</span></span>
<span><span class="co">#&gt; 3 s__Bacteroides_intestinalis 9_None vs 12_Mild</span></span>
<span><span class="co">#&gt;        metadata</span></span>
<span><span class="co">#&gt; 1 LiverFatClass</span></span>
<span><span class="co">#&gt; 2 LiverFatClass</span></span>
<span><span class="co">#&gt; 3 LiverFatClass</span></span></code></pre></div>
<p>结果：校正的pval也即是qval均大于0.05，没有筛选出差异物种，为了可视化结果，下图用了qvalue阈值为0.8。</p>
<ul>
<li>可视化结果</li>
</ul>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Maaslin2_pl</span> <span class="op">&lt;-</span> <span class="fu">get_Maaslin2_pl</span><span class="op">(</span></span>
<span>  dat <span class="op">=</span> <span class="va">Maaslin2_df</span><span class="op">$</span><span class="va">test_res</span>,</span>
<span>  lg2fc_cutoff <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  pval_cutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  qval_cutoff <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  group_color <span class="op">=</span> <span class="va">lf_col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  plot_title <span class="op">=</span> <span class="st">"None vs Mild"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Maaslin2_pl</span></span></code></pre></div>
<div class="inline-figure"><img src="30-Metagenome_DifferentialAnalysis_files/figure-html/unnamed-chunk-11-1.png" width="100%"></div>
<p>结果：9类差异菌富集在None组，2类差异菌富集在Mild组</p>
<p>同时推荐使用MicrobiomeAnalysis内置的火山图<code>plot_volcano</code>函数，它提供了更多的参数用于可视化火山图。</p>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/plot_volcano.html">plot_volcano</a></span><span class="op">(</span></span>
<span>  da_res <span class="op">=</span> <span class="va">Maaslin2_df</span><span class="op">$</span><span class="va">test_res</span>,</span>
<span>  group_names <span class="op">=</span> <span class="va">lf_grp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  x_index <span class="op">=</span> <span class="st">"coef"</span>,</span>
<span>  x_index_cutoff <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  y_index <span class="op">=</span> <span class="st">"pval"</span>,</span>
<span>  y_index_cutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  topN <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  group_colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">lf_col</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"grey"</span>, <span class="va">lf_col</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  add_enrich_arrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-Metagenome_DifferentialAnalysis_files/figure-html/unnamed-chunk-12-1.png" width="100%"></div>
<ul>
<li>箱线图展示特定菌</li>
</ul>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_boxplot</span><span class="op">(</span></span>
<span>  ps <span class="op">=</span> <span class="va">Maaslin2_df</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>  feature <span class="op">=</span> <span class="st">"s__Ruminococcus_torques"</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"LiverFatClass"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span><span class="op">)</span>,</span>
<span>  group_color <span class="op">=</span> <span class="va">lf_col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  pl_title <span class="op">=</span> <span class="st">"Ruminococcus_torques"</span>,</span>
<span>  pos_cutoff <span class="op">=</span> <span class="op">-</span><span class="fl">0.002</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-Metagenome_DifferentialAnalysis_files/figure-html/unnamed-chunk-13-1.png" width="100%"></div>
<p>结果：<em>Ruminococcus_torques</em>在None组出现率均很高，并且相对丰度在None组更高。</p>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_boxplot</span><span class="op">(</span></span>
<span>  ps <span class="op">=</span> <span class="va">Maaslin2_df</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>  feature <span class="op">=</span> <span class="st">"s__Streptococcus_oralis"</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"LiverFatClass"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span><span class="op">)</span>,</span>
<span>  group_color <span class="op">=</span> <span class="va">lf_col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  pl_title <span class="op">=</span> <span class="st">"Streptococcus_oralis"</span>,</span>
<span>  pos_cutoff <span class="op">=</span> <span class="op">-</span><span class="fl">0.002</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-Metagenome_DifferentialAnalysis_files/figure-html/unnamed-chunk-14-1.png" width="100%"></div>
<p>结果：<em>Streptococcus_oralis</em>在Mild组出现率均很高，并且相对丰度在Mild组更高。</p>
</div>
<div id="analysis-of-composition-of-microbiomes-with-bias-correction-ancom-bc" class="section level2" number="15.6">
<h2>
<span class="header-section-number">15.6</span> Analysis of Composition of Microbiomes with Bias Correction (ANCOM-BC)<a class="anchor" aria-label="anchor" href="#analysis-of-composition-of-microbiomes-with-bias-correction-ancom-bc"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>计算函数</li>
</ul>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ANCOMBC</span></span>
<span><span class="va">get_ANCOMBC</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">ps</span>,</span>
<span>  <span class="va">taxa_level</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="st">"Phylum"</span>, <span class="st">"Class"</span>, <span class="st">"Order"</span>, </span>
<span>                 <span class="st">"Family"</span>, <span class="st">"Genus"</span>, <span class="st">"Species"</span>, <span class="st">"Strain"</span><span class="op">)</span>,</span>
<span>  <span class="va">filterCol</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">filterVars</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">group</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LiverFatClass"</span>, <span class="st">"Gender"</span><span class="op">)</span>,</span>
<span>  <span class="va">group_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span>, <span class="st">"Moderate"</span>, <span class="st">"Severe"</span>,</span>
<span>                  <span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span>,</span>
<span>  <span class="va">prev_cutoff</span> <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  <span class="va">mean_threshold</span> <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  <span class="va">one_threshold</span> <span class="op">=</span> <span class="fl">1000</span>,  </span>
<span>  <span class="va">fix_vars</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Age"</span>, <span class="st">"Gender"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># ps = phy_count</span></span>
<span>  <span class="co"># taxa_level = NULL</span></span>
<span>  <span class="co"># filterCol = NULL</span></span>
<span>  <span class="co"># filterVars = NULL</span></span>
<span>  <span class="co"># group = "LiverFatClass"</span></span>
<span>  <span class="co"># group_names = c("None", "Mild")</span></span>
<span>  <span class="co"># prev_cutoff = 0.1</span></span>
<span>  <span class="co"># mean_threshold = 100</span></span>
<span>  <span class="co"># one_threshold = 1000  </span></span>
<span>  <span class="co"># fix_vars = c("Age", "Gender")</span></span>
<span>  </span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">taxa_level</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ps_taxa</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/aggregate_taxa.html">aggregate_taxa</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">ps</span>, level <span class="op">=</span> <span class="va">taxa_level</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">ps_taxa</span> <span class="op">&lt;-</span> <span class="va">ps</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">metadata</span> <span class="op">&lt;-</span> <span class="va">ps_taxa</span><span class="op">@</span><span class="va">sam_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">filterCol</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dat_cln</span> <span class="op">&lt;-</span> <span class="va">metadata</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span> <span class="op">==</span> <span class="va">filterCol</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"FiltCol"</span></span>
<span>    <span class="va">dat_cln</span> <span class="op">&lt;-</span> <span class="va">metadata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">FiltCol</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">filterVars</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span> <span class="op">==</span> <span class="st">"FiltCol"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">filterCol</span>   </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># group for test </span></span>
<span>  <span class="va">dat_cln2</span> <span class="op">&lt;-</span> <span class="va">dat_cln</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln2</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln2</span><span class="op">)</span> <span class="op">==</span> <span class="va">group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Group_new"</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="st">"all"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dat_cln3</span> <span class="op">&lt;-</span> <span class="va">dat_cln2</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">dat_cln3</span> <span class="op">&lt;-</span> <span class="va">dat_cln2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Group_new</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">dat_cln3</span><span class="op">$</span><span class="va">Group_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">$</span><span class="va">Group_new</span>, levels <span class="op">=</span> <span class="va">group_names</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Group_new"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group</span></span>
<span>  </span>
<span>  <span class="va">ps_temp</span> <span class="op">&lt;-</span> <span class="va">ps_taxa</span></span>
<span>  <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps_temp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">dat_cln3</span><span class="op">)</span>  </span>
<span>  </span>
<span>  <span class="co"># trim &amp; filter</span></span>
<span>  <span class="va">ps_trim</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/trim_prevalence.html">trim_prevalence</a></span><span class="op">(</span></span>
<span>    object <span class="op">=</span> <span class="va">ps_temp</span>,</span>
<span>    cutoff <span class="op">=</span> <span class="va">prev_cutoff</span>,</span>
<span>    trim <span class="op">=</span> <span class="st">"feature"</span><span class="op">)</span></span>
<span>  <span class="va">ps_filter</span> <span class="op">&lt;-</span> <span class="fu">MicrobiomeAnalysis</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MicrobiomeAnalysis/man/filter_abundance.html">filter_abundance</a></span><span class="op">(</span></span>
<span>    object <span class="op">=</span> <span class="va">ps_trim</span>,</span>
<span>    cutoff_mean <span class="op">=</span> <span class="va">mean_threshold</span>,</span>
<span>    cutoff_one <span class="op">=</span> <span class="va">one_threshold</span><span class="op">)</span></span>
<span>  <span class="va">ps_filter</span> <span class="op">&lt;-</span> <span class="va">ps_trim</span></span>
<span>  </span>
<span>  <span class="co">#################################################################</span></span>
<span>  <span class="co"># https://www.bioconductor.org/packages/release/bioc/vignettes/ANCOMBC/inst/doc/ANCOMBC.html</span></span>
<span></span>
<span>  <span class="va">fix_factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">fix_vars</span><span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">ANCOMBC</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ANCOMBC/man/ancombc.html">ancombc</a></span><span class="op">(</span></span>
<span>    phyloseq <span class="op">=</span> <span class="va">ps_filter</span>,</span>
<span>    formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">fix_factors</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span>, </span>
<span>    p_adj_method <span class="op">=</span> <span class="st">"BH"</span>, </span>
<span>    prv_cut <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    lib_cut <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    group <span class="op">=</span> <span class="va">group</span>,</span>
<span>    struc_zero <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    neg_lb <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    tol <span class="op">=</span> <span class="fl">1e-05</span>,</span>
<span>    max_iter <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    conserve <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    global <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    n_cl <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  </span>
<span>  </span>
<span>  <span class="co"># Result from the ANCOM-BC log-linear model to determine taxa that are differentially abundant according to the covariate of interest. </span></span>
<span>  <span class="co"># It contains: 1) log fold changes; 2) standard errors; </span></span>
<span>  <span class="co"># 3) test statistics; 4) p-values; 5) adjusted p-values; </span></span>
<span>  <span class="co"># 6) indicators whether the taxon is differentially abundant (TRUE) or not (FALSE)  </span></span>
<span>  </span>
<span>  <span class="va">res_list</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">res</span></span>
<span>  <span class="va">res_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">res_list</span><span class="op">$</span><span class="va">lfc</span><span class="op">$</span><span class="va">taxon</span>,</span>
<span>                    <span class="va">res_list</span><span class="op">$</span><span class="va">lfc</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>                    <span class="va">res_list</span><span class="op">$</span><span class="va">se</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>                    <span class="va">res_list</span><span class="op">$</span><span class="va">W</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>                    <span class="va">res_list</span><span class="op">$</span><span class="va">p_val</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>                    <span class="va">res_list</span><span class="op">$</span><span class="va">q_val</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>                    <span class="va">res_list</span><span class="op">$</span><span class="va">diff_abn</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"feature"</span>, <span class="st">"lfc"</span>, <span class="st">"se"</span>, <span class="st">"W"</span>, <span class="st">"p_val"</span>, <span class="st">"q_val"</span>, <span class="st">"diff_abu"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Number of Group</span></span>
<span>  <span class="va">input_metadata</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps_filter</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>   </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">)</span> <span class="op">==</span> <span class="va">group</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Compvar"</span></span>
<span>  <span class="va">dat_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">input_metadata</span><span class="op">$</span><span class="va">Compvar</span><span class="op">)</span></span>
<span>  <span class="va">dat_status_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">dat_status</span><span class="op">)</span></span>
<span>  <span class="va">dat_status_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dat_status</span><span class="op">)</span></span>
<span>  <span class="va">res_temp</span><span class="op">$</span><span class="va">Block</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">dat_status_number</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">dat_status_name</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>,</span>
<span>                       <span class="st">"vs"</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">dat_status_number</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">dat_status_name</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">res_test</span> <span class="op">&lt;-</span> <span class="va">res_temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">feature</span>, <span class="va">Block</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">ps_filter</span><span class="op">@</span><span class="va">tax_table</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                        <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="st">"feature"</span><span class="op">)</span>,</span>
<span>                      by <span class="op">=</span> <span class="st">"feature"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>TaxaID <span class="op">=</span> <span class="va">feature</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Enrichment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">lfc</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">TaxaID</span>, <span class="va">Block</span>, <span class="va">lfc</span>, <span class="va">Enrichment</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># final results list</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="va">ps_filter</span>,</span>
<span>              test_res <span class="op">=</span> <span class="va">res_test</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="va">get_ANCOMBC_pl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">dat</span>,</span>
<span>    <span class="va">lg2fc_cutoff</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    <span class="va">pval_cutoff</span> <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    <span class="va">qval_cutoff</span> <span class="op">=</span> <span class="fl">0.8</span>, <span class="co">#0.05,</span></span>
<span>    <span class="va">group_color</span>,</span>
<span>    <span class="va">plot_title</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># group_names</span></span>
<span>  <span class="va">group_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\d+_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Block</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" vs "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">dat</span><span class="op">$</span><span class="va">lg2fc</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">$</span><span class="va">lfc</span></span>
<span>  <span class="va">dat</span><span class="op">$</span><span class="va">pval</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">$</span><span class="va">p_val</span></span>
<span>  <span class="va">dat</span><span class="op">$</span><span class="va">qval</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">$</span><span class="va">q_val</span></span>
<span>  </span>
<span>  <span class="co"># enrichment by beta and Pvalue AdjustedPvalue</span></span>
<span>  <span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">lg2fc</span> <span class="op">&gt;</span> <span class="va">lg2fc_cutoff</span> <span class="op">&amp;</span> </span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span> <span class="op">&amp;</span> </span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">lg2fc</span> <span class="op">&lt;</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span> <span class="op">&amp;</span> </span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span> <span class="op">&amp;</span> </span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">lg2fc</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">lg2fc_cutoff</span> <span class="op">|</span> </span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">pval</span> <span class="op">&gt;=</span> <span class="va">pval_cutoff</span> <span class="op">|</span></span>
<span>              <span class="va">dat</span><span class="op">$</span><span class="va">qval</span> <span class="op">&gt;=</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"EnrichedDir"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Nonsignif"</span>   </span>
<span>  </span>
<span>  <span class="va">dat</span><span class="op">$</span><span class="va">EnrichedDir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">EnrichedDir</span>,</span>
<span>                            levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"Nonsignif"</span>, <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># dat status </span></span>
<span>  <span class="va">df_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">EnrichedDir</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Group"</span>, <span class="st">"Number"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">grp1_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">grp2_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">nsf_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">df_status</span>, <span class="va">df_status</span><span class="op">[</span><span class="va">Group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="st">"Nonsignif"</span>, <span class="st">"Number"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">legend_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">" ("</span>, <span class="va">grp1_number</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Nonsignif"</span>, <span class="st">" ("</span>, <span class="va">nsf_number</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" ("</span>, <span class="va">grp2_number</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># significant features</span></span>
<span>  <span class="va">dat_signif</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">lg2fc</span>, <span class="va">pval</span>, <span class="va">qval</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>    </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">lg2fc</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">lg2fc_cutoff</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># color </span></span>
<span>  <span class="va">plot_group_color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">group_color</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"grey"</span>, <span class="va">group_color</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">plot_group_color</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"Nonsignif"</span>, <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># labels</span></span>
<span>  <span class="va">xlabel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Log2FC[ANCOMBC] ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="va">group_names</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span></span>
<span>  <span class="va">ylable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="op">-</span><span class="va">log</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span><span class="op">(</span><span class="st">"Pvalue (AdjustedPvalue &lt; 0.25)"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lg2fc</span>, y <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">pval</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">EnrichedDir</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">1</span>, stroke <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       values <span class="op">=</span> <span class="va">plot_group_color</span>,</span>
<span>                       labels <span class="op">=</span> <span class="va">legend_label</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="va">xlabel</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="va">ylable</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">lg2fc_cutoff</span>, alpha <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="fl">2</span>, size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span>, alpha <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="fl">2</span>, size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>             x <span class="op">=</span> <span class="va">lg2fc_cutoff</span>, y <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             label <span class="op">=</span> <span class="va">lg2fc_cutoff</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">5</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span>, y <span class="op">=</span> <span class="fl">0</span>,</span>
<span>             label <span class="op">=</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">5</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log1p"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">pval_cutoff</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="fl">2</span>, size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>             x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">lg2fc</span><span class="op">)</span>,</span>
<span>             y <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">pval_cutoff</span><span class="op">)</span>,</span>
<span>             label <span class="op">=</span> <span class="va">pval_cutoff</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">5</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html">geom_text_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat_signif</span>,</span>
<span>                             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">TaxaID</span><span class="op">)</span>,</span>
<span>                             size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                             max.overlaps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"ggrepel.max.overlaps"</span>, default <span class="op">=</span> <span class="fl">80</span><span class="op">)</span>,</span>
<span>                             segment.linetype <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                             segment.curvature <span class="op">=</span> <span class="op">-</span><span class="fl">1e-20</span>,</span>
<span>                             box.padding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.35</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>                             point.padding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>                             arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.005</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                             bg.r <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, face <span class="op">=</span> <span class="st">"bold"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>          axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">9</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>          text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>          legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.15</span>, <span class="fl">.1</span><span class="op">)</span>,</span>
<span>          legend.key.height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>          legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">9</span>, face <span class="op">=</span> <span class="st">"bold"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          legend.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># legend background transparency</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="va">plot_title</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">12</span>, hjust <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pl</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<ul>
<li>ANCOMBC结果</li>
</ul>
<p>以LiverFatClass作为分组，选择None和Mild两个分组进行差异分析</p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ANCOMBC_df</span> <span class="op">&lt;-</span> <span class="fu">get_ANCOMBC</span><span class="op">(</span></span>
<span>  ps <span class="op">=</span> <span class="va">phy_count</span>,</span>
<span>  taxa_level <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  filterCol <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  filterVars <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"LiverFatClass"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span><span class="op">)</span>,</span>
<span>  prev_cutoff <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  mean_threshold <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  one_threshold <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  fix_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Age"</span>, <span class="st">"Gender"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ANCOMBC_df</span><span class="op">$</span><span class="va">test_res</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         TaxaID             Block</span></span>
<span><span class="co">#&gt; 1  s__Actinomyces_graevenitzii 9_None vs 12_Mild</span></span>
<span><span class="co">#&gt; 2 s__Actinomyces_odontolyticus 9_None vs 12_Mild</span></span>
<span><span class="co">#&gt; 3      s__Actinomyces_sp_ICM47 9_None vs 12_Mild</span></span>
<span><span class="co">#&gt;           lfc</span></span>
<span><span class="co">#&gt; 1 -0.69410607</span></span>
<span><span class="co">#&gt; 2  0.07148274</span></span>
<span><span class="co">#&gt; 3  1.80267320</span></span></code></pre></div>
<p>结果：校正的pval也即是qval均大于0.05，没有筛选出差异物种，为了可视化结果，下图用了qvalue阈值为0.8。</p>
<ul>
<li>可视化结果</li>
</ul>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ANCOMBC_pl</span> <span class="op">&lt;-</span> <span class="fu">get_ANCOMBC_pl</span><span class="op">(</span></span>
<span>  dat <span class="op">=</span> <span class="va">ANCOMBC_df</span><span class="op">$</span><span class="va">test_res</span>,</span>
<span>  lg2fc_cutoff <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  pval_cutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  qval_cutoff <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>  group_color <span class="op">=</span> <span class="va">lf_col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  plot_title <span class="op">=</span> <span class="st">"None vs Mild"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ANCOMBC_pl</span></span></code></pre></div>
<div class="inline-figure"><img src="30-Metagenome_DifferentialAnalysis_files/figure-html/unnamed-chunk-17-1.png" width="100%"></div>
<p>结果：14类差异菌富集在None组，7类差异菌富集在Mild组</p>
<ul>
<li>箱线图展示特定菌</li>
</ul>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_boxplot</span><span class="op">(</span></span>
<span>  ps <span class="op">=</span> <span class="va">ANCOMBC_df</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>  feature <span class="op">=</span> <span class="st">"s__Dorea_longicatena"</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"LiverFatClass"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span><span class="op">)</span>,</span>
<span>  group_color <span class="op">=</span> <span class="va">lf_col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  pl_title <span class="op">=</span> <span class="st">"Dorea_longicatena"</span>,</span>
<span>  pos_cutoff <span class="op">=</span> <span class="op">-</span><span class="fl">15000</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-Metagenome_DifferentialAnalysis_files/figure-html/unnamed-chunk-18-1.png" width="100%"></div>
<p>结果：<em>Dorea_longicatena</em>在None组出现率均很高，并且相对丰度在None组更高。</p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_boxplot</span><span class="op">(</span></span>
<span>  ps <span class="op">=</span> <span class="va">ANCOMBC_df</span><span class="op">$</span><span class="va">ps</span>,</span>
<span>  feature <span class="op">=</span> <span class="st">"s__Clostridium_leptum"</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"LiverFatClass"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Mild"</span><span class="op">)</span>,</span>
<span>  group_color <span class="op">=</span> <span class="va">lf_col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  pl_title <span class="op">=</span> <span class="st">"Clostridium_leptum"</span>,</span>
<span>  pos_cutoff <span class="op">=</span> <span class="op">-</span><span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="30-Metagenome_DifferentialAnalysis_files/figure-html/unnamed-chunk-19-1.png" width="100%"></div>
<p>结果：<em>Clostridium_leptum</em>在Mild组出现率均很高，并且相对丰度在Mild组更高。</p>
</div>
<div id="合并上述结果" class="section level2" number="15.7">
<h2>
<span class="header-section-number">15.7</span> 合并上述结果<a class="anchor" aria-label="anchor" href="#%E5%90%88%E5%B9%B6%E4%B8%8A%E8%BF%B0%E7%BB%93%E6%9E%9C"><i class="fas fa-link"></i></a>
</h2>
<p>以lefse的结果为基准，合并上述三种分析方法的结果。</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_mergeRes</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">DA1</span>,</span>
<span>    <span class="va">DA2</span>,</span>
<span>    <span class="va">DA3</span>,</span>
<span>    <span class="va">lg2fc_cutoff</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    <span class="va">pval_cutoff</span> <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    <span class="va">qval_cutoff</span> <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>    <span class="va">group_colors</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># DA1 = lefse_df$test_res</span></span>
<span>  <span class="co"># DA2 = Maaslin2_df$test_res</span></span>
<span>  <span class="co"># DA3 = ANCOMBC_df$test_res</span></span>
<span>  <span class="co"># lg2fc_cutoff = 0</span></span>
<span>  <span class="co"># pval_cutoff = 0.05</span></span>
<span>  <span class="co"># qval_cutoff = 0.8</span></span>
<span>  <span class="co"># group_colors = lf_col[c(1, 2)]</span></span>
<span>  </span>
<span>  <span class="co"># group_names</span></span>
<span>  <span class="va">group_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\d+_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">DA1</span><span class="op">$</span><span class="va">Block</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">" vs "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  </span>
<span>  </span>
<span>  <span class="va">DA_lefse_cln</span> <span class="op">&lt;-</span> <span class="va">DA1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">TaxaID</span>, <span class="va">Block</span>, <span class="va">LDA_Score</span>, <span class="va">Enrichment</span>,</span>
<span>                  <span class="va">Kingdom</span>, <span class="va">Phylum</span>, <span class="va">Genus</span>, <span class="va">Species</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>Lefse_Enrichment <span class="op">=</span> <span class="va">Enrichment</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">DA_maaslin2_cln</span> <span class="op">&lt;-</span> <span class="va">DA2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">TaxaID</span>, <span class="va">coef</span>, <span class="va">Enrichment</span>,</span>
<span>                  <span class="va">pval</span>, <span class="va">qval</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>lg2fc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">coef</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>Maaslin2_Enrichment <span class="op">=</span> <span class="va">Enrichment</span>,</span>
<span>                  Maaslin2_pval <span class="op">=</span> <span class="va">pval</span>,</span>
<span>                  Maaslin2_qval <span class="op">=</span> <span class="va">qval</span>,</span>
<span>                  Maaslin2_lg2fc <span class="op">=</span> <span class="va">lg2fc</span><span class="op">)</span> </span>
<span>  <span class="va">DA_maaslin2_cln</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">DA_maaslin2_cln</span><span class="op">$</span><span class="va">Maaslin2_lg2fc</span> <span class="op">&gt;</span> <span class="va">lg2fc_cutoff</span> <span class="op">&amp;</span> </span>
<span>            <span class="va">DA_maaslin2_cln</span><span class="op">$</span><span class="va">Maaslin2_pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span> <span class="op">&amp;</span> </span>
<span>            <span class="va">DA_maaslin2_cln</span><span class="op">$</span><span class="va">Maaslin2_qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"Maaslin2_Enrichment"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">DA_maaslin2_cln</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">DA_maaslin2_cln</span><span class="op">$</span><span class="va">Maaslin2_lg2fc</span> <span class="op">&lt;</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span> <span class="op">&amp;</span> </span>
<span>            <span class="va">DA_maaslin2_cln</span><span class="op">$</span><span class="va">Maaslin2_pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span> <span class="op">&amp;</span> </span>
<span>            <span class="va">DA_maaslin2_cln</span><span class="op">$</span><span class="va">Maaslin2_qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"Maaslin2_Enrichment"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">DA_maaslin2_cln</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">DA_maaslin2_cln</span><span class="op">$</span><span class="va">Maaslin2_lg2fc</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">lg2fc_cutoff</span> <span class="op">|</span> </span>
<span>            <span class="va">DA_maaslin2_cln</span><span class="op">$</span><span class="va">Maaslin2_pval</span> <span class="op">&gt;=</span> <span class="va">pval_cutoff</span> <span class="op">|</span></span>
<span>            <span class="va">DA_maaslin2_cln</span><span class="op">$</span><span class="va">Maaslin2_qval</span> <span class="op">&gt;=</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"Maaslin2_Enrichment"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Nonsignif"</span>   </span>
<span>  </span>
<span>  <span class="va">DA_ANCOMBC_cln</span> <span class="op">&lt;-</span> <span class="va">DA3</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">TaxaID</span>, <span class="va">lfc</span>, <span class="va">Enrichment</span>,</span>
<span>                  <span class="va">p_val</span>, <span class="va">q_val</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>ANCOMBC_Enrichment <span class="op">=</span> <span class="va">Enrichment</span>,</span>
<span>                  ANCOMBC_pval <span class="op">=</span> <span class="va">p_val</span>,</span>
<span>                  ANCOMBC_qval <span class="op">=</span> <span class="va">q_val</span>,</span>
<span>                  ANCOMBC_lg2fc <span class="op">=</span> <span class="va">lfc</span><span class="op">)</span> </span>
<span>  <span class="va">DA_ANCOMBC_cln</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">DA_ANCOMBC_cln</span><span class="op">$</span><span class="va">ANCOMBC_lg2fc</span> <span class="op">&gt;</span> <span class="va">lg2fc_cutoff</span> <span class="op">&amp;</span> </span>
<span>            <span class="va">DA_ANCOMBC_cln</span><span class="op">$</span><span class="va">ANCOMBC_pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span> <span class="op">&amp;</span> </span>
<span>            <span class="va">DA_ANCOMBC_cln</span><span class="op">$</span><span class="va">ANCOMBC_qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"ANCOMBC_Enrichment"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">DA_ANCOMBC_cln</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">DA_ANCOMBC_cln</span><span class="op">$</span><span class="va">ANCOMBC_lg2fc</span> <span class="op">&lt;</span> <span class="op">-</span><span class="va">lg2fc_cutoff</span> <span class="op">&amp;</span> </span>
<span>            <span class="va">DA_ANCOMBC_cln</span><span class="op">$</span><span class="va">ANCOMBC_pval</span> <span class="op">&lt;</span> <span class="va">pval_cutoff</span> <span class="op">&amp;</span> </span>
<span>            <span class="va">DA_ANCOMBC_cln</span><span class="op">$</span><span class="va">ANCOMBC_qval</span> <span class="op">&lt;</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"ANCOMBC_Enrichment"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">group_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">DA_ANCOMBC_cln</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">DA_ANCOMBC_cln</span><span class="op">$</span><span class="va">ANCOMBC_lg2fc</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">lg2fc_cutoff</span> <span class="op">|</span> </span>
<span>            <span class="va">DA_ANCOMBC_cln</span><span class="op">$</span><span class="va">ANCOMBC_pval</span> <span class="op">&gt;=</span> <span class="va">pval_cutoff</span> <span class="op">|</span></span>
<span>            <span class="va">DA_ANCOMBC_cln</span><span class="op">$</span><span class="va">ANCOMBC_qval</span> <span class="op">&gt;=</span> <span class="va">qval_cutoff</span><span class="op">)</span>,</span>
<span>      <span class="st">"ANCOMBC_Enrichment"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Nonsignif"</span>   </span>
<span>  </span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">DA_lefse_cln</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">DA_maaslin2_cln</span>,</span>
<span>                      by <span class="op">=</span> <span class="st">"TaxaID"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">DA_ANCOMBC_cln</span>,</span>
<span>                      by <span class="op">=</span> <span class="st">"TaxaID"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">TaxaID</span>, <span class="va">Block</span>, <span class="va">LDA_Score</span>, <span class="va">Lefse_Enrichment</span>,</span>
<span>                  <span class="va">Maaslin2_Enrichment</span>, <span class="va">coef</span>, <span class="va">Maaslin2_lg2fc</span>, <span class="va">Maaslin2_pval</span>, <span class="va">Maaslin2_qval</span>,</span>
<span>                  <span class="va">ANCOMBC_Enrichment</span>, <span class="va">ANCOMBC_lg2fc</span>, <span class="va">ANCOMBC_pval</span>, <span class="va">ANCOMBC_qval</span>,</span>
<span>                  <span class="va">Kingdom</span>, <span class="va">Phylum</span>, <span class="va">Genus</span>, <span class="va">Species</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">TaxaID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Signif <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">Maaslin2_Enrichment</span> <span class="op">!=</span> <span class="st">"Nonsignif"</span>,</span>
<span>          <span class="va">ANCOMBC_Enrichment</span> <span class="op">!=</span> <span class="st">"Nonsignif"</span><span class="op">)</span>, <span class="st">"+"</span>, </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Maaslin2_Enrichment</span> <span class="op">!=</span> <span class="st">"Nonsignif"</span>, <span class="st">"*"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">ANCOMBC_Enrichment</span> <span class="op">!=</span> <span class="st">"Nonsignif"</span>, <span class="st">"#"</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co"># dplyr::mutate(Signif = ifelse(Maaslin2_Enrichment != "Nonsignif", "*",</span></span>
<span>    <span class="co">#                               ifelse(ANCOMBC_Enrichment != "Nonsignif", "#", </span></span>
<span>    <span class="co">#                                      ifelse(all(Maaslin2_Enrichment != "Nonsignif",</span></span>
<span>    <span class="co">#                                                 ANCOMBC_Enrichment != "Nonsignif"), </span></span>
<span>    <span class="co">#                                             "+", "")))) %&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^t__"</span>, <span class="va">res</span><span class="op">$</span><span class="va">TaxaID</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">plotdata</span> <span class="op">&lt;-</span> <span class="va">res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">TaxaID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>TaxaID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"t__"</span>, <span class="st">""</span>, <span class="va">TaxaID</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>FeatureID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">TaxaID</span>, <span class="st">" ("</span>, <span class="va">Species</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FeatureID</span>, <span class="va">LDA_Score</span>, <span class="va">Lefse_Enrichment</span>, <span class="va">Signif</span>, <span class="va">Phylum</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Lefse_Enrichment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Lefse_Enrichment</span>, levels <span class="op">=</span> <span class="va">group_names</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        FeatureID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">FeatureID</span>, levels <span class="op">=</span> <span class="va">FeatureID</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">LDA_Score</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        label_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">LDA_Score</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0.2</span>, <span class="op">-</span><span class="fl">0.2</span><span class="op">)</span>,</span>
<span>        label_hjust <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">LDA_Score</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>        label_hjust2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">LDA_Score</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">plotdata</span> <span class="op">&lt;-</span> <span class="va">res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>FeatureID <span class="op">=</span> <span class="va">TaxaID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">FeatureID</span>, <span class="va">LDA_Score</span>, <span class="va">Lefse_Enrichment</span>, <span class="va">Signif</span>, <span class="va">Phylum</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Lefse_Enrichment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Lefse_Enrichment</span>, levels <span class="op">=</span> <span class="va">group_names</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        FeatureID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">FeatureID</span>, levels <span class="op">=</span> <span class="va">FeatureID</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">LDA_Score</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        label_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">LDA_Score</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0.2</span>, <span class="op">-</span><span class="fl">0.2</span><span class="op">)</span>,</span>
<span>        label_hjust <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">LDA_Score</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>        label_hjust2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">LDA_Score</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"unclassified"</span>, <span class="va">plotdata</span><span class="op">$</span><span class="va">Phylum</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">plotdata</span> <span class="op">&lt;-</span> <span class="va">plotdata</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"unclassified"</span>, <span class="va">plotdata</span><span class="op">$</span><span class="va">Phylum</span><span class="op">)</span>, , <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Phylum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"p__"</span>, <span class="st">""</span>, <span class="va">Phylum</span><span class="op">)</span><span class="op">)</span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">plotdata</span> <span class="op">&lt;-</span> <span class="va">plotdata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Phylum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"p__"</span>, <span class="st">""</span>, <span class="va">Phylum</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">plotdata</span><span class="op">$</span><span class="va">Phylum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">plotdata</span><span class="op">$</span><span class="va">Phylum</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">plotdata</span><span class="op">$</span><span class="va">Phylum</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">phylum_colors</span> <span class="op">&lt;-</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">plotdata</span><span class="op">$</span><span class="va">Phylum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                                            name <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plotdata</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">FeatureID</span>, y <span class="op">=</span> <span class="va">LDA_Score</span>, fill <span class="op">=</span> <span class="va">Lefse_Enrichment</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">label_y</span>, label <span class="op">=</span> <span class="va">FeatureID</span>, hjust <span class="op">=</span> <span class="va">label_hjust</span>, color <span class="op">=</span> <span class="va">Phylum</span><span class="op">)</span>, fontface <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">LDA_Score</span>, label <span class="op">=</span> <span class="va">Signif</span>, hjust <span class="op">=</span> <span class="va">label_hjust2</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">+</span>    </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">log</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span><span class="op">(</span><span class="fu">italic</span><span class="op">(</span><span class="st">"LDA score"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       breaks <span class="op">=</span> <span class="op">-</span><span class="fl">4</span><span class="op">:</span><span class="fl">4</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="cn">NULL</span>, values <span class="op">=</span> <span class="va">group_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Phylum"</span>, values <span class="op">=</span> <span class="va">phylum_colors</span><span class="op">)</span> <span class="op">+</span>    </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>order <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>           color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>order <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>          legend.justification <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>          panel.grid.major.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          panel.grid.minor.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"grey80"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span>,</span>
<span>          panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pl</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">Merge_DA_pl</span> <span class="op">&lt;-</span> <span class="fu">get_mergeRes</span><span class="op">(</span></span>
<span>  DA1 <span class="op">=</span> <span class="va">lefse_df</span><span class="op">$</span><span class="va">test_res</span>,</span>
<span>  DA2 <span class="op">=</span> <span class="va">Maaslin2_df</span><span class="op">$</span><span class="va">test_res</span>,</span>
<span>  DA3 <span class="op">=</span> <span class="va">ANCOMBC_df</span><span class="op">$</span><span class="va">test_res</span>,</span>
<span>  lg2fc_cutoff <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  pval_cutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  qval_cutoff <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  group_colors <span class="op">=</span> <span class="va">lf_col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Merge_DA_pl</span></span></code></pre></div>
<div class="inline-figure"><img src="30-Metagenome_DifferentialAnalysis_files/figure-html/unnamed-chunk-20-1.png" width="100%"></div>
<p>结果：</p>
<ul>
<li><p>Differential abundance of metagenomic species measured by linear discriminant analysis of effect size (LefSe) according to the LiverFatClass group.</p></li>
<li><p>LDA; Linear discriminant analysis.</p></li>
<li><p><strong>+</strong> Multivariate analysis (ANCOM-BC &amp; Maaslin2) with a false discovery rate (FDR) adjusted p-value &lt; 0.8.</p></li>
<li><p>* Multivariate analysis (Maaslin2) with a false discovery rate (FDR) adjusted p-value &lt; 0.8.</p></li>
<li><p><strong>#</strong> Multivariate analysis (ANCOM-BC) with a false discovery rate (FDR) adjusted p-value &lt; 0.8.</p></li>
</ul>
</div>
<div id="总结-5" class="section level2" number="15.8">
<h2>
<span class="header-section-number">15.8</span> 总结<a class="anchor" aria-label="anchor" href="#%E6%80%BB%E7%BB%93-5"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>三种差异分析方法筛选出来的物种（以lefse作为基准）的交集相对较多（高于50%）。</p></li>
<li><p>三种差异方法，Maaslin2方法相对最严苛，筛选出的差异物种较少，而lefse和ANCOM-BC则筛选出较多物种。lefse没有考虑到多重检验校正，ANCOM-BC使用零膨胀以及校正样本间差异方法，这导致了更多差异物种被识别出来。需要注意点是，从后面单个物种的箱线图能看出，需要对物种出现率进行严格的过滤，可避免出现低出现率物种被识别出来（根据研究目的选择恰当的过滤参数）。</p></li>
</ul>
</div>
<div id="session-info-7" class="section level2" number="15.9">
<h2>
<span class="header-section-number">15.9</span> Session info<a class="anchor" aria-label="anchor" href="#session-info-7"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://r-lib.github.io/sessioninfo/reference/session_info.html">session_info</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; ─ Session info ───────────────────────────────────────────</span></span>
<span><span class="co">#&gt;  setting  value</span></span>
<span><span class="co">#&gt;  version  R version 4.3.1 (2023-06-16)</span></span>
<span><span class="co">#&gt;  os       macOS Monterey 12.2.1</span></span>
<span><span class="co">#&gt;  system   x86_64, darwin20</span></span>
<span><span class="co">#&gt;  ui       X11</span></span>
<span><span class="co">#&gt;  language (EN)</span></span>
<span><span class="co">#&gt;  collate  en_US.UTF-8</span></span>
<span><span class="co">#&gt;  ctype    en_US.UTF-8</span></span>
<span><span class="co">#&gt;  tz       Asia/Shanghai</span></span>
<span><span class="co">#&gt;  date     2024-02-06</span></span>
<span><span class="co">#&gt;  pandoc   3.1.3 @ /Users/zouhua/opt/anaconda3/bin/ (via rmarkdown)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ─ Packages ───────────────────────────────────────────────</span></span>
<span><span class="co">#&gt;  package                  * version    date (UTC) lib source</span></span>
<span><span class="co">#&gt;  abind                      1.4-5      2016-07-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ade4                       1.7-22     2023-02-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ANCOMBC                  * 2.4.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  ape                        5.7-1      2023-03-13 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  backports                  1.4.1      2021-12-13 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  base64enc                  0.1-3      2015-07-28 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  beachmat                   2.18.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  beeswarm                   0.4.0      2021-06-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  biglm                      0.9-2.1    2020-11-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  Biobase                    2.62.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  BiocGenerics               0.48.1     2023-11-01 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  BiocNeighbors              1.20.2     2024-01-07 [1] Bioconductor 3.18 (R 4.3.2)</span></span>
<span><span class="co">#&gt;  BiocParallel               1.36.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  BiocSingular               1.18.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  biomformat                 1.30.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  Biostrings                 2.70.2     2024-01-28 [1] Bioconductor 3.18 (R 4.3.2)</span></span>
<span><span class="co">#&gt;  bit                        4.0.5      2022-11-15 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  bit64                      4.0.5      2020-08-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  bitops                     1.0-7      2021-04-24 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  blob                       1.2.4      2023-03-17 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  bluster                    1.12.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  bookdown                   0.37       2023-12-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  boot                       1.3-28.1   2022-11-22 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  broom                      1.0.5      2023-06-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  bslib                      0.6.1      2023-11-28 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  cachem                     1.0.8      2023-05-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  car                        3.1-2      2023-03-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  carData                    3.0-5      2022-01-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  caTools                    1.18.2     2021-03-28 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  cellranger                 1.1.0      2016-07-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  checkmate                  2.3.1      2023-12-04 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  class                      7.3-22     2023-05-03 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  cli                        3.6.2      2023-12-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  cluster                    2.1.4      2022-08-22 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  codetools                  0.2-19     2023-02-01 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  colorspace                 2.1-0      2023-01-23 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  cowplot                    1.1.3      2024-01-22 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  crayon                     1.5.2      2022-09-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  CVXR                       1.0-12     2024-02-02 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  data.table                 1.15.0     2024-01-30 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  DBI                        1.2.1      2024-01-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  DECIPHER                   2.30.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  decontam                   1.22.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  DelayedArray               0.28.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  DelayedMatrixStats         1.24.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  DEoptimR                   1.1-3      2023-10-07 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  DescTools                  0.99.54    2024-02-03 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  DESeq2                     1.42.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  devtools                   2.4.5      2022-10-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  digest                     0.6.34     2024-01-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  DirichletMultinomial       1.44.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  doParallel                 1.0.17     2022-02-07 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  doRNG                    * 1.8.6      2023-01-16 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  downlit                    0.4.3      2023-06-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  dplyr                    * 1.1.4      2023-11-17 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  e1071                      1.7-14     2023-12-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ellipsis                   0.3.2      2021-04-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  energy                     1.7-11     2022-12-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  evaluate                   0.23       2023-11-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  Exact                      3.2        2022-09-25 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  expm                       0.999-9    2024-01-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  fansi                      1.0.6      2023-12-08 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  farver                     2.1.1      2022-07-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  fastmap                    1.1.1      2023-02-24 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  forcats                  * 1.0.0      2023-01-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  foreach                  * 1.5.2      2022-02-02 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  foreign                    0.8-84     2022-12-06 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  Formula                    1.2-5      2023-02-24 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  fs                         1.6.3      2023-07-20 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  generics                   0.1.3      2022-07-05 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  GenomeInfoDb               1.38.5     2023-12-28 [1] Bioconductor 3.18 (R 4.3.2)</span></span>
<span><span class="co">#&gt;  GenomeInfoDbData           1.2.11     2024-01-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  GenomicRanges              1.54.1     2023-10-29 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  getopt                     1.20.4     2023-10-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggbeeswarm                 0.7.2      2023-04-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggplot2                  * 3.4.4      2023-10-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggpubr                   * 0.6.0      2023-02-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggrepel                    0.9.5      2024-01-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ggsignif                   0.6.4      2022-10-13 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  gld                        2.6.6      2022-10-23 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  glmnet                     4.1-8      2023-08-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  glue                       1.7.0      2024-01-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  gmp                        0.7-4      2024-01-15 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  gplots                     3.1.3.1    2024-02-02 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  gridExtra                  2.3        2017-09-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  gsl                        2.1-8      2023-01-24 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  gtable                     0.3.4      2023-08-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  gtools                     3.9.5      2023-11-20 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  hash                       2.2.6.3    2023-08-19 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  highr                      0.10       2022-12-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  Hmisc                      5.1-1      2023-09-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  hms                        1.1.3      2023-03-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  htmlTable                  2.4.2      2023-10-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  htmltools                  0.5.7      2023-11-03 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  htmlwidgets                1.6.4      2023-12-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  httpuv                     1.6.14     2024-01-26 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  httr                       1.4.7      2023-08-15 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  igraph                     2.0.1.1    2024-01-30 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  IRanges                    2.36.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  irlba                      2.3.5.1    2022-10-03 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  iterators                  1.0.14     2022-02-05 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  jquerylib                  0.1.4      2021-04-26 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  jsonlite                   1.8.8      2023-12-04 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  KernSmooth                 2.23-21    2023-05-03 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  knitr                      1.45       2023-10-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  labeling                   0.4.3      2023-08-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  later                      1.3.2      2023-12-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  lattice                    0.21-8     2023-04-05 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  lazyeval                   0.2.2      2019-03-15 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  lifecycle                  1.0.4      2023-11-07 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  limma                      3.58.1     2023-10-31 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  lme4                       1.1-35.1   2023-11-05 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  lmerTest                   3.1-3      2020-10-23 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  lmom                       3.0        2023-08-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  locfit                     1.5-9.8    2023-06-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  logging                    0.10-108   2019-07-14 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  lpsymphony                 1.30.0     2023-10-24 [1] Bioconductor (R 4.3.1)</span></span>
<span><span class="co">#&gt;  lubridate                * 1.9.3      2023-09-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  Maaslin2                 * 1.7.3      2024-01-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  magrittr                   2.0.3      2022-03-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  MASS                       7.3-60     2023-05-04 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  Matrix                     1.6-5      2024-01-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  MatrixGenerics             1.14.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  matrixStats                1.2.0      2023-12-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  memoise                    2.0.1      2021-11-26 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  metagenomeSeq              1.43.0     2023-04-25 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  mgcv                       1.8-42     2023-03-02 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  mia                        1.10.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  MicrobiomeAnalysis       * 1.0.3      2024-02-06 [1] Github (HuaZou/MicrobiomeAnalysis@fd2a6a2)</span></span>
<span><span class="co">#&gt;  mime                       0.12       2021-09-28 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  miniUI                     0.1.1.1    2018-05-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  minqa                      1.2.6      2023-09-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  multcomp                   1.4-25     2023-06-20 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  MultiAssayExperiment       1.28.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  multtest                   2.58.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  munsell                    0.5.0      2018-06-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  mvtnorm                    1.2-4      2023-11-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  nlme                       3.1-162    2023-01-31 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  nloptr                     2.0.3      2022-05-26 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  nnet                       7.3-19     2023-05-03 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  numDeriv                   2016.8-1.1 2019-06-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  optparse                   1.7.4      2024-01-16 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pbapply                    1.7-2      2023-06-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pcaPP                      2.0-4      2023-12-07 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  permute                    0.9-7      2022-01-27 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  phyloseq                 * 1.46.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  pillar                     1.9.0      2023-03-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pkgbuild                   1.4.3      2023-12-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pkgconfig                  2.0.3      2019-09-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  pkgload                    1.3.4      2024-01-16 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  plyr                       1.8.9      2023-10-02 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  profvis                    0.3.8      2023-05-02 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  promises                   1.2.1      2023-08-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  proxy                      0.4-27     2022-06-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  purrr                    * 1.0.2      2023-08-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  R6                         2.5.1      2021-08-19 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rbibutils                  2.2.16     2023-10-25 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  RColorBrewer               1.1-3      2022-04-03 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  Rcpp                       1.0.12     2024-01-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  RCurl                      1.98-1.14  2024-01-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  Rdpack                     2.6        2023-11-08 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  readr                    * 2.1.5      2024-01-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  readxl                     1.4.3      2023-07-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  remotes                    2.4.2.1    2023-07-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  reshape2                   1.4.4      2020-04-09 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rhdf5                      2.46.1     2023-11-29 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  rhdf5filters               1.14.1     2023-11-06 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  Rhdf5lib                   1.24.1     2023-12-12 [1] Bioconductor 3.18 (R 4.3.2)</span></span>
<span><span class="co">#&gt;  rlang                      1.1.3      2024-01-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rmarkdown                  2.25       2023-09-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  Rmpfr                      0.9-5      2024-01-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rngtools                 * 1.5.2      2021-09-20 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  robustbase                 0.99-1     2023-11-29 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rootSolve                  1.8.2.4    2023-09-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rpart                      4.1.19     2022-10-21 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  RSQLite                    2.3.5      2024-01-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rstatix                    0.7.2      2023-02-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rstudioapi                 0.15.0     2023-07-07 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  rsvd                       1.0.5      2021-04-16 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  S4Arrays                   1.2.0      2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  S4Vectors                  0.40.2     2023-11-23 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  sandwich                   3.1-0      2023-12-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  sass                       0.4.8      2023-12-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  ScaledMatrix               1.10.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  scales                     1.3.0      2023-11-28 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  scater                     1.30.1     2023-12-06 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  scuttle                    1.12.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  sessioninfo                1.2.2      2021-12-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  shape                      1.4.6      2021-05-19 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  shiny                      1.8.0      2023-11-17 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  SingleCellExperiment       1.24.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  SparseArray                1.2.3      2023-12-25 [1] Bioconductor 3.18 (R 4.3.2)</span></span>
<span><span class="co">#&gt;  sparseMatrixStats          1.14.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  statmod                    1.5.0      2023-01-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  stringi                    1.8.3      2023-12-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  stringr                  * 1.5.1      2023-11-14 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  SummarizedExperiment       1.32.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  survival                   3.5-5      2023-03-12 [1] CRAN (R 4.3.1)</span></span>
<span><span class="co">#&gt;  TH.data                    1.1-2      2023-04-17 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  tibble                   * 3.2.1      2023-03-20 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  tidyr                    * 1.3.1      2024-01-24 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  tidyselect                 1.2.0      2022-10-10 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  tidytree                   0.4.6      2023-12-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  tidyverse                * 2.0.0      2023-02-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  timechange                 0.3.0      2024-01-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  treeio                     1.26.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  TreeSummarizedExperiment   2.10.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  tzdb                       0.4.0      2023-05-12 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  urlchecker                 1.0.1      2021-11-30 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  usethis                    2.2.2      2023-07-06 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  utf8                       1.2.4      2023-10-22 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  vctrs                      0.6.5      2023-12-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  vegan                      2.6-4      2022-10-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  vipor                      0.4.7      2023-12-18 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  viridis                    0.6.5      2024-01-29 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  viridisLite                0.4.2      2023-05-02 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  withr                      3.0.0      2024-01-16 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  Wrench                     1.20.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  xfun                       0.41       2023-11-01 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  xml2                       1.3.6      2023-12-04 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  xtable                     1.8-4      2019-04-21 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  XVector                    0.42.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  yaml                       2.3.8      2023-12-11 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt;  yulab.utils                0.1.4      2024-01-28 [1] CRAN (R 4.3.2)</span></span>
<span><span class="co">#&gt;  zlibbioc                   1.48.0     2023-10-24 [1] Bioconductor</span></span>
<span><span class="co">#&gt;  zoo                        1.8-12     2023-04-13 [1] CRAN (R 4.3.0)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  [1] /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/library</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ──────────────────────────────────────────────────────────</span></span></code></pre></div>
</div>
<div id="reference-13" class="section level2" number="15.10">
<h2>
<span class="header-section-number">15.10</span> Reference<a class="anchor" aria-label="anchor" href="#reference-13"><i class="fas fa-link"></i></a>
</h2>

</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="OtherAnalysis.html"><span class="header-section-number">14</span> Other Analysis</a></div>
<div class="next"><a href="randomforestalgorithm.html"><span class="header-section-number">16</span> Random Forest Algorithm</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#MultipleDifferetialAnalysis"><span class="header-section-number">15</span> Multiple Differetial Analysis</a></li>
<li><a class="nav-link" href="#%E5%AE%89%E8%A3%85microbiomeanalysis%E5%8C%85-1"><span class="header-section-number">15.1</span> 安装MicrobiomeAnalysis包</a></li>
<li><a class="nav-link" href="#%E5%8A%A0%E8%BD%BDr%E5%8C%85-12"><span class="header-section-number">15.2</span> 加载R包</a></li>
<li><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE-10"><span class="header-section-number">15.3</span> 导入数据</a></li>
<li><a class="nav-link" href="#linear-discriminant-analysis-of-effect-size-lefse"><span class="header-section-number">15.4</span> Linear Discriminant Analysis of Effect Size (LefSe)</a></li>
<li><a class="nav-link" href="#microbiome-multivariable-association-with-linear-models-maaslin2"><span class="header-section-number">15.5</span> Microbiome Multivariable Association with Linear Models (Maaslin2)</a></li>
<li><a class="nav-link" href="#analysis-of-composition-of-microbiomes-with-bias-correction-ancom-bc"><span class="header-section-number">15.6</span> Analysis of Composition of Microbiomes with Bias Correction (ANCOM-BC)</a></li>
<li><a class="nav-link" href="#%E5%90%88%E5%B9%B6%E4%B8%8A%E8%BF%B0%E7%BB%93%E6%9E%9C"><span class="header-section-number">15.7</span> 合并上述结果</a></li>
<li><a class="nav-link" href="#%E6%80%BB%E7%BB%93-5"><span class="header-section-number">15.8</span> 总结</a></li>
<li><a class="nav-link" href="#session-info-7"><span class="header-section-number">15.9</span> Session info</a></li>
<li><a class="nav-link" href="#reference-13"><span class="header-section-number">15.10</span> Reference</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/HuaZou/DraftNotes/blob/main/30-Metagenome_DifferentialAnalysis.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/HuaZou/DraftNotes/edit/main/30-Metagenome_DifferentialAnalysis.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>生物信息随记</strong>" was written by Hua Zou. It was last built on 2023-08-24 and updated on 2024-02-06.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
